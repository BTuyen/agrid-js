{"version":3,"file":"error-properties-builder.js","sourceRoot":"","sources":["error-properties-builder.ts"],"names":[],"mappings":"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","sourcesContent":["import { isArray } from '@/utils'\nimport { getFilenameToChunkIdMap } from './chunk-ids'\nimport { createStackParser } from './parsers'\nimport {\n  ErrorProperties,\n  ExceptionLike,\n  ExceptionList,\n  CoercingContext,\n  StackFrame,\n  StackFrameModifierFn,\n  StackParser,\n  ErrorTrackingCoercer,\n  EventHint,\n  StackLineParser,\n  ParsingContext,\n  ChunkIdMapType,\n  Mechanism,\n  ParsedException,\n  Exception,\n} from './types'\n\nconst MAX_CAUSE_RECURSION = 4\n\nexport class ErrorPropertiesBuilder {\n  stackParser: StackParser\n\n  constructor(\n    private coercers: ErrorTrackingCoercer<any>[] = [],\n    parsers: StackLineParser[] = [],\n    private modifiers: StackFrameModifierFn[] = []\n  ) {\n    this.stackParser = createStackParser(...parsers)\n  }\n\n  buildFromUnknown(input: unknown, hint: EventHint = {}): ErrorProperties {\n    const providedMechanism = hint && hint.mechanism\n    const mechanism = providedMechanism || {\n      handled: true,\n      type: 'generic',\n    }\n    const coercingContext: CoercingContext = this.buildCoercingContext(mechanism, hint, 0)\n    const exceptionWithCause = coercingContext.apply(input)\n    const parsingContext: ParsingContext = this.buildParsingContext()\n    const exceptionWithStack = this.parseStacktrace(exceptionWithCause, parsingContext)\n    const exceptionList = this.convertToExceptionList(exceptionWithStack, mechanism)\n    return {\n      $exception_list: exceptionList,\n      $exception_level: 'error',\n    }\n  }\n\n  async modifyFrames(exceptionList: ErrorProperties['$exception_list']): Promise<ErrorProperties['$exception_list']> {\n    for (const exc of exceptionList) {\n      if (exc.stacktrace && exc.stacktrace.frames && isArray(exc.stacktrace.frames)) {\n        exc.stacktrace.frames = await this.applyModifiers(exc.stacktrace.frames)\n      }\n    }\n    return exceptionList\n  }\n\n  private coerceFallback(ctx: CoercingContext): ExceptionLike {\n    return {\n      type: 'Error',\n      value: 'Unknown error',\n      stack: ctx.syntheticException?.stack,\n      synthetic: true,\n    }\n  }\n\n  private parseStacktrace(err: ExceptionLike, ctx: ParsingContext): ParsedException {\n    let cause: ParsedException | undefined = undefined\n    if (err.cause != null) {\n      cause = this.parseStacktrace(err.cause, ctx)\n    }\n    let stack: StackFrame[] | undefined = undefined\n    if (err.stack != '' && err.stack != null) {\n      stack = this.applyChunkIds(this.stackParser(err.stack, err.synthetic ? 1 : 0), ctx.chunkIdMap)\n    }\n    return { ...err, cause, stack }\n  }\n\n  private applyChunkIds(frames: StackFrame[], chunkIdMap?: ChunkIdMapType): StackFrame[] {\n    return frames.map((frame) => {\n      if (frame.filename && chunkIdMap) {\n        frame.chunk_id = chunkIdMap[frame.filename]\n      }\n      return frame\n    })\n  }\n\n  private applyCoercers(input: unknown, ctx: CoercingContext): ExceptionLike | undefined {\n    for (const adapter of this.coercers) {\n      if (adapter.match(input)) {\n        return adapter.coerce(input, ctx)\n      }\n    }\n    return this.coerceFallback(ctx)\n  }\n\n  private async applyModifiers(frames: StackFrame[]): Promise<StackFrame[]> {\n    let newFrames = frames\n    for (const modifier of this.modifiers) {\n      newFrames = await modifier(newFrames)\n    }\n    return newFrames\n  }\n\n  private convertToExceptionList(exceptionWithStack: ParsedException, mechanism: Mechanism): ExceptionList {\n    const currentException: Exception = {\n      type: exceptionWithStack.type,\n      value: exceptionWithStack.value,\n      mechanism: {\n        type: mechanism.type ?? 'generic',\n        handled: mechanism.handled ?? true,\n        synthetic: exceptionWithStack.synthetic ?? false,\n      },\n    }\n    if (exceptionWithStack.stack) {\n      currentException.stacktrace = {\n        type: 'raw',\n        frames: exceptionWithStack.stack,\n      }\n    }\n    const exceptionList: ExceptionList = [currentException]\n    if (exceptionWithStack.cause != null) {\n      // Cause errors are necessarily handled\n      exceptionList.push(\n        ...this.convertToExceptionList(exceptionWithStack.cause, {\n          ...mechanism,\n          handled: true,\n        })\n      )\n    }\n    return exceptionList\n  }\n\n  private buildParsingContext(): ParsingContext {\n    const context = {\n      chunkIdMap: getFilenameToChunkIdMap(this.stackParser),\n    } as ParsingContext\n    return context\n  }\n\n  private buildCoercingContext(mechanism: Mechanism, hint: EventHint, depth: number = 0): CoercingContext {\n    const coerce = (input: unknown, depth: number) => {\n      if (depth <= MAX_CAUSE_RECURSION) {\n        const ctx = this.buildCoercingContext(mechanism, hint, depth)\n        return this.applyCoercers(input, ctx)\n      } else {\n        return undefined\n      }\n    }\n    const context = {\n      ...hint,\n      // Do not propagate synthetic exception as it doesn't make sense\n      syntheticException: depth == 0 ? hint.syntheticException : undefined,\n      mechanism,\n      apply: (input: unknown) => {\n        return coerce(input, depth)\n      },\n      next: (input: unknown) => {\n        return coerce(input, depth + 1)\n      },\n    } as CoercingContext\n    return context\n  }\n}\n"]}