{"version":3,"file":"node.js","sourceRoot":"","sources":["node.ts"],"names":[],"mappings":"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","sourcesContent":["import { StackLineParser } from '../types'\nimport { UNKNOWN_FUNCTION } from './base'\n\n/** Node Stack line parser */\nconst FILENAME_MATCH = /^\\s*[-]{4,}$/\nconst FULL_MATCH = /at (?:async )?(?:(.+?)\\s+\\()?(?:(.+):(\\d+):(\\d+)?|([^)]+))\\)?/\n\nexport const nodeStackLineParser: StackLineParser = (line: string) => {\n  const lineMatch = line.match(FULL_MATCH)\n\n  if (lineMatch) {\n    let object: string | undefined\n    let method: string | undefined\n    let functionName: string | undefined\n    let typeName: string | undefined\n    let methodName: string | undefined\n\n    if (lineMatch[1]) {\n      functionName = lineMatch[1]\n\n      let methodStart = functionName.lastIndexOf('.')\n      if (functionName[methodStart - 1] === '.') {\n        methodStart--\n      }\n\n      if (methodStart > 0) {\n        object = functionName.slice(0, methodStart)\n        method = functionName.slice(methodStart + 1)\n        const objectEnd = object.indexOf('.Module')\n        if (objectEnd > 0) {\n          functionName = functionName.slice(objectEnd + 1)\n          object = object.slice(0, objectEnd)\n        }\n      }\n      typeName = undefined\n    }\n\n    if (method) {\n      typeName = object\n      methodName = method\n    }\n\n    if (method === '<anonymous>') {\n      methodName = undefined\n      functionName = undefined\n    }\n\n    if (functionName === undefined) {\n      methodName = methodName || UNKNOWN_FUNCTION\n      functionName = typeName ? `${typeName}.${methodName}` : methodName\n    }\n\n    let filename = lineMatch[2]?.startsWith('file://') ? lineMatch[2].slice(7) : lineMatch[2]\n    const isNative = lineMatch[5] === 'native'\n\n    // If it's a Windows path, trim the leading slash so that `/C:/foo` becomes `C:/foo`\n    if (filename?.match(/\\/[A-Z]:/)) {\n      filename = filename.slice(1)\n    }\n\n    if (!filename && lineMatch[5] && !isNative) {\n      filename = lineMatch[5]\n    }\n\n    return {\n      filename: filename ? decodeURI(filename) : undefined,\n      module: undefined,\n      function: functionName,\n      lineno: _parseIntOrUndefined(lineMatch[3]),\n      colno: _parseIntOrUndefined(lineMatch[4]),\n      in_app: filenameIsInApp(filename || '', isNative),\n      platform: 'node:javascript',\n    }\n  }\n\n  if (line.match(FILENAME_MATCH)) {\n    return {\n      filename: line,\n      platform: 'node:javascript',\n    }\n  }\n\n  return undefined\n}\n\n/**\n * Does this filename look like it's part of the app code?\n */\nfunction filenameIsInApp(filename: string, isNative: boolean = false): boolean {\n  const isInternal =\n    isNative ||\n    (filename &&\n      // It's not internal if it's an absolute linux path\n      !filename.startsWith('/') &&\n      // It's not internal if it's an absolute windows path\n      !filename.match(/^[A-Z]:/) &&\n      // It's not internal if the path is starting with a dot\n      !filename.startsWith('.') &&\n      // It's not internal if the frame has a protocol. In node, this is usually the case if the file got pre-processed with a bundler like webpack\n      !filename.match(/^[a-zA-Z]([a-zA-Z0-9.\\-+])*:\\/\\//)) // Schema from: https://stackoverflow.com/a/3641782\n\n  // in_app is all that's not an internal Node function or a module within node_modules\n  // note that isNative appears to return true even for node core libraries\n  // see https://github.com/getsentry/raven-node/issues/176\n\n  return !isInternal && filename !== undefined && !filename.includes('node_modules/')\n}\n\nfunction _parseIntOrUndefined(input: string | undefined): number | undefined {\n  return parseInt(input || '', 10) || undefined\n}\n"]}