{"version":3,"file":"bucketed-rate-limiter.js","sourceRoot":"","sources":["bucketed-rate-limiter.ts"],"names":[],"mappings":";;;AACA,+CAA6C;AAG7C,IAAM,aAAa,GAAG,QAAQ,CAAA;AAE9B;IAOE,6BAAY,OAMX;QARO,aAAQ,GAA2B,EAAE,CAAA;QAS3C,IAAI,CAAC,oBAAoB,GAAG,OAAO,CAAC,oBAAoB,CAAA;QACxD,IAAI,CAAC,WAAW,GAAG,IAAA,2BAAY,EAAC,OAAO,CAAC,UAAU,EAAE,CAAC,EAAE,GAAG,EAAE,OAAO,CAAC,OAAO,CAAC,CAAA;QAC5E,IAAI,CAAC,WAAW,GAAG,IAAA,2BAAY,EAAC,OAAO,CAAC,UAAU,EAAE,CAAC,EAAE,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,OAAO,CAAC,CAAA;QACzF,IAAI,CAAC,eAAe,GAAG,IAAA,2BAAY,EAAC,OAAO,CAAC,cAAc,EAAE,CAAC,EAAE,aAAa,EAAE,OAAO,CAAC,OAAO,CAAC,CAAA;IAChG,CAAC;IAEO,0CAAY,GAApB,UAAqB,MAAc,EAAE,GAAW;QAC9C,IAAM,SAAS,GAAG,GAAG,GAAG,MAAM,CAAC,UAAU,CAAA;QACzC,IAAM,eAAe,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,CAAA;QAEpE,IAAI,eAAe,GAAG,CAAC,EAAE,CAAC;YACxB,IAAM,WAAW,GAAG,eAAe,GAAG,IAAI,CAAC,WAAW,CAAA;YACtD,MAAM,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,MAAM,GAAG,WAAW,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;YACvE,MAAM,CAAC,UAAU,GAAG,MAAM,CAAC,UAAU,GAAG,eAAe,GAAG,IAAI,CAAC,eAAe,CAAA;QAChF,CAAC;IACH,CAAC;IAEM,8CAAgB,GAAvB,UAAwB,GAAM;;QAC5B,IAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;QACtB,IAAM,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC,CAAA;QAE1B,IAAI,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAA;QAElC,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,GAAG,EAAE,MAAM,EAAE,IAAI,CAAC,WAAW,EAAE,UAAU,EAAE,GAAG,EAAE,CAAA;YACtD,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,MAAM,CAAA;QAChC,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,GAAG,CAAC,CAAA;QAChC,CAAC;QAED,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACxB,OAAO,IAAI,CAAA;QACb,CAAC;QAED,MAAM,CAAC,MAAM,EAAE,CAAA;QAEf,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACxB,MAAA,IAAI,CAAC,oBAAoB,qDAAG,GAAG,CAAC,CAAA;QAClC,CAAC;QAED,OAAO,MAAM,CAAC,MAAM,KAAK,CAAC,CAAA;IAC5B,CAAC;IAEM,kCAAI,GAAX;QACE,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAA;IACpB,CAAC;IACH,0BAAC;AAAD,CAAC,AA5DD,IA4DC;AA5DY,kDAAmB","sourcesContent":["import { Logger } from '../types'\nimport { clampToRange } from './number-utils'\n\ntype Bucket = { tokens: number; lastAccess: number }\nconst ONE_DAY_IN_MS = 86400000\n\nexport class BucketedRateLimiter<T extends string | number> {\n  private _bucketSize: number\n  private _refillRate: number\n  private _refillInterval: number\n  private _onBucketRateLimited?: (key: T) => void\n  private _buckets: Record<string, Bucket> = {}\n\n  constructor(options: {\n    bucketSize: number\n    refillRate: number\n    refillInterval: number\n    _logger: Logger\n    _onBucketRateLimited?: (key: T) => void\n  }) {\n    this._onBucketRateLimited = options._onBucketRateLimited\n    this._bucketSize = clampToRange(options.bucketSize, 0, 100, options._logger)\n    this._refillRate = clampToRange(options.refillRate, 0, this._bucketSize, options._logger)\n    this._refillInterval = clampToRange(options.refillInterval, 0, ONE_DAY_IN_MS, options._logger)\n  }\n\n  private _applyRefill(bucket: Bucket, now: number): void {\n    const elapsedMs = now - bucket.lastAccess\n    const refillIntervals = Math.floor(elapsedMs / this._refillInterval)\n\n    if (refillIntervals > 0) {\n      const tokensToAdd = refillIntervals * this._refillRate\n      bucket.tokens = Math.min(bucket.tokens + tokensToAdd, this._bucketSize)\n      bucket.lastAccess = bucket.lastAccess + refillIntervals * this._refillInterval\n    }\n  }\n\n  public consumeRateLimit(key: T): boolean {\n    const now = Date.now()\n    const keyStr = String(key)\n\n    let bucket = this._buckets[keyStr]\n\n    if (!bucket) {\n      bucket = { tokens: this._bucketSize, lastAccess: now }\n      this._buckets[keyStr] = bucket\n    } else {\n      this._applyRefill(bucket, now)\n    }\n\n    if (bucket.tokens === 0) {\n      return true\n    }\n\n    bucket.tokens--\n\n    if (bucket.tokens === 0) {\n      this._onBucketRateLimited?.(key)\n    }\n\n    return bucket.tokens === 0\n  }\n\n  public stop(): void {\n    this._buckets = {}\n  }\n}\n"]}