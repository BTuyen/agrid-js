{"version":3,"file":"featureFlagUtils.js","sourceRoot":"","sources":["featureFlagUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  FeatureFlagDetail,\n  FeatureFlagValue,\n  JsonType,\n  PostHogFlagsResponse,\n  PostHogV1FlagsResponse,\n  PostHogV2FlagsResponse,\n  PostHogFlagsAndPayloadsResponse,\n  PartialWithRequired,\n  PostHogFeatureFlagsResponse,\n} from './types'\n\nexport const normalizeFlagsResponse = (\n  flagsResponse:\n    | PartialWithRequired<PostHogV2FlagsResponse, 'flags'>\n    | PartialWithRequired<PostHogV1FlagsResponse, 'featureFlags' | 'featureFlagPayloads'>\n): PostHogFeatureFlagsResponse => {\n  if ('flags' in flagsResponse) {\n    // Convert v2 format to v1 format\n    const featureFlags = getFlagValuesFromFlags(flagsResponse.flags)\n    const featureFlagPayloads = getPayloadsFromFlags(flagsResponse.flags)\n\n    return {\n      ...flagsResponse,\n      featureFlags,\n      featureFlagPayloads,\n    }\n  } else {\n    // Convert v1 format to v2 format\n    const featureFlags = flagsResponse.featureFlags ?? {}\n    const featureFlagPayloads = Object.fromEntries(\n      Object.entries(flagsResponse.featureFlagPayloads || {}).map(([k, v]) => [k, parsePayload(v)])\n    )\n\n    const flags = Object.fromEntries(\n      Object.entries(featureFlags).map(([key, value]) => [\n        key,\n        getFlagDetailFromFlagAndPayload(key, value, featureFlagPayloads[key]),\n      ])\n    )\n\n    return {\n      ...flagsResponse,\n      featureFlags,\n      featureFlagPayloads,\n      flags,\n    }\n  }\n}\n\nfunction getFlagDetailFromFlagAndPayload(\n  key: string,\n  value: FeatureFlagValue,\n  payload: JsonType | undefined\n): FeatureFlagDetail {\n  return {\n    key: key,\n    enabled: typeof value === 'string' ? true : value,\n    variant: typeof value === 'string' ? value : undefined,\n    reason: undefined,\n    metadata: {\n      id: undefined,\n      version: undefined,\n      payload: payload ? JSON.stringify(payload) : undefined,\n      description: undefined,\n    },\n  }\n}\n\n/**\n * Get the flag values from the flags v4 response.\n * @param flags - The flags\n * @returns The flag values\n */\nexport const getFlagValuesFromFlags = (flags: PostHogFlagsResponse['flags']): PostHogFlagsResponse['featureFlags'] => {\n  return Object.fromEntries(\n    Object.entries(flags ?? {})\n      .map(([key, detail]) => [key, getFeatureFlagValue(detail)])\n      .filter(([, value]): boolean => value !== undefined)\n  )\n}\n\n/**\n * Get the payloads from the flags v4 response.\n * @param flags - The flags\n * @returns The payloads\n */\nexport const getPayloadsFromFlags = (\n  flags: PostHogFlagsResponse['flags']\n): PostHogFlagsResponse['featureFlagPayloads'] => {\n  const safeFlags = flags ?? {}\n  return Object.fromEntries(\n    Object.keys(safeFlags)\n      .filter((flag) => {\n        const details = safeFlags[flag]\n        return details.enabled && details.metadata && details.metadata.payload !== undefined\n      })\n      .map((flag) => {\n        const payload = safeFlags[flag].metadata?.payload as string\n        return [flag, payload ? parsePayload(payload) : undefined]\n      })\n  )\n}\n\n/**\n * Get the flag details from the legacy v1 flags and payloads. As such, it will lack the reason, id, version, and description.\n * @param flagsResponse - The flags response\n * @returns The flag details\n */\nexport const getFlagDetailsFromFlagsAndPayloads = (\n  flagsResponse: PostHogFeatureFlagsResponse\n): PostHogFlagsResponse['flags'] => {\n  const flags = flagsResponse.featureFlags ?? {}\n  const payloads = flagsResponse.featureFlagPayloads ?? {}\n  return Object.fromEntries(\n    Object.entries(flags).map(([key, value]) => [\n      key,\n      {\n        key: key,\n        enabled: typeof value === 'string' ? true : value,\n        variant: typeof value === 'string' ? value : undefined,\n        reason: undefined,\n        metadata: {\n          id: undefined,\n          version: undefined,\n          payload: payloads?.[key] ? JSON.stringify(payloads[key]) : undefined,\n          description: undefined,\n        },\n      },\n    ])\n  )\n}\n\nexport const getFeatureFlagValue = (detail: FeatureFlagDetail | undefined): FeatureFlagValue | undefined => {\n  return detail === undefined ? undefined : (detail.variant ?? detail.enabled)\n}\n\nexport const parsePayload = (response: any): any => {\n  if (typeof response !== 'string') {\n    return response\n  }\n\n  try {\n    return JSON.parse(response)\n  } catch {\n    return response\n  }\n}\n\n/**\n * Get the normalized flag details from the flags and payloads.\n * This is used to convert things like bootstrap and stored feature flags and payloads to the v4 format.\n * This helps us ensure backwards compatibility.\n * If a key exists in the featureFlagPayloads that is not in the featureFlags, we treat it as a true feature flag.\n *\n * @param featureFlags - The feature flags\n * @param featureFlagPayloads - The feature flag payloads\n * @returns The normalized flag details\n */\nexport const createFlagsResponseFromFlagsAndPayloads = (\n  featureFlags: PostHogV1FlagsResponse['featureFlags'],\n  featureFlagPayloads: PostHogV1FlagsResponse['featureFlagPayloads']\n): PostHogFeatureFlagsResponse => {\n  // If a feature flag payload key is not in the feature flags, we treat it as true feature flag.\n  const allKeys = [...new Set([...Object.keys(featureFlags ?? {}), ...Object.keys(featureFlagPayloads ?? {})])]\n  const enabledFlags = allKeys\n    .filter((flag) => !!featureFlags[flag] || !!featureFlagPayloads[flag])\n    .reduce((res: Record<string, FeatureFlagValue>, key) => ((res[key] = featureFlags[key] ?? true), res), {})\n\n  const flagDetails: PostHogFlagsAndPayloadsResponse = {\n    featureFlags: enabledFlags,\n    featureFlagPayloads: featureFlagPayloads ?? {},\n  }\n\n  return normalizeFlagsResponse(flagDetails as PostHogV1FlagsResponse)\n}\n\nexport const updateFlagValue = (flag: FeatureFlagDetail, value: FeatureFlagValue): FeatureFlagDetail => {\n  return {\n    ...flag,\n    enabled: getEnabledFromValue(value),\n    variant: getVariantFromValue(value),\n  }\n}\n\nfunction getEnabledFromValue(value: FeatureFlagValue): boolean {\n  return typeof value === 'string' ? true : value\n}\n\nfunction getVariantFromValue(value: FeatureFlagValue): string | undefined {\n  return typeof value === 'string' ? value : undefined\n}\n"]}