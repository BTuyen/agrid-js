{"version":3,"file":"posthog-core.js","sourceRoot":"","sources":["posthog-core.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  PostHogAutocaptureElement,\n  PostHogFlagsResponse,\n  PostHogCoreOptions,\n  PostHogEventProperties,\n  PostHogCaptureOptions,\n  JsonType,\n  PostHogRemoteConfig,\n  FeatureFlagValue,\n  PostHogV2FlagsResponse,\n  PostHogV1FlagsResponse,\n  PostHogFeatureFlagDetails,\n  PostHogFlagsStorageFormat,\n  FeatureFlagDetail,\n  Survey,\n  SurveyResponse,\n  PostHogGroupProperties,\n} from './types'\nimport {\n  createFlagsResponseFromFlagsAndPayloads,\n  getFeatureFlagValue,\n  getFlagValuesFromFlags,\n  getPayloadsFromFlags,\n  normalizeFlagsResponse,\n  updateFlagValue,\n} from './featureFlagUtils'\nimport { Compression, PostHogPersistedProperty } from './types'\nimport { maybeAdd, PostHogCoreStateless, QuotaLimitedFeature } from './posthog-core-stateless'\nimport { uuidv7 } from './vendor/uuidv7'\nimport { isPlainError } from './utils'\n\nexport abstract class PostHogCore extends PostHogCoreStateless {\n  // options\n  private sendFeatureFlagEvent: boolean\n  private flagCallReported: { [key: string]: boolean } = {}\n\n  // internal\n  protected _flagsResponsePromise?: Promise<PostHogFlagsResponse | undefined> // TODO: come back to this, fix typing\n  protected _sessionExpirationTimeSeconds: number\n  private _sessionMaxLengthSeconds: number = 24 * 60 * 60 // 24 hours\n  protected sessionProps: PostHogEventProperties = {}\n\n  constructor(apiKey: string, options?: PostHogCoreOptions) {\n    // Default for stateful mode is to not disable geoip. Only override if explicitly set\n    const disableGeoipOption = options?.disableGeoip ?? false\n\n    // Default for stateful mode is to timeout at 10s. Only override if explicitly set\n    const featureFlagsRequestTimeoutMs = options?.featureFlagsRequestTimeoutMs ?? 10000 // 10 seconds\n\n    super(apiKey, { ...options, disableGeoip: disableGeoipOption, featureFlagsRequestTimeoutMs })\n\n    this.sendFeatureFlagEvent = options?.sendFeatureFlagEvent ?? true\n    this._sessionExpirationTimeSeconds = options?.sessionExpirationTimeSeconds ?? 1800 // 30 minutes\n  }\n\n  protected setupBootstrap(options?: Partial<PostHogCoreOptions>): void {\n    const bootstrap = options?.bootstrap\n    if (!bootstrap) {\n      return\n    }\n\n    // bootstrap options are only set if no persisted values are found\n    // this is to prevent overwriting existing values\n    if (bootstrap.distinctId) {\n      if (bootstrap.isIdentifiedId) {\n        const distinctId = this.getPersistedProperty(PostHogPersistedProperty.DistinctId)\n\n        if (!distinctId) {\n          this.setPersistedProperty(PostHogPersistedProperty.DistinctId, bootstrap.distinctId)\n        }\n      } else {\n        const anonymousId = this.getPersistedProperty(PostHogPersistedProperty.AnonymousId)\n\n        if (!anonymousId) {\n          this.setPersistedProperty(PostHogPersistedProperty.AnonymousId, bootstrap.distinctId)\n        }\n      }\n    }\n\n    const bootstrapFeatureFlags = bootstrap.featureFlags\n    const bootstrapFeatureFlagPayloads = bootstrap.featureFlagPayloads ?? {}\n    if (bootstrapFeatureFlags && Object.keys(bootstrapFeatureFlags).length) {\n      const normalizedBootstrapFeatureFlagDetails = createFlagsResponseFromFlagsAndPayloads(\n        bootstrapFeatureFlags,\n        bootstrapFeatureFlagPayloads\n      )\n\n      if (Object.keys(normalizedBootstrapFeatureFlagDetails.flags).length > 0) {\n        this.setBootstrappedFeatureFlagDetails(normalizedBootstrapFeatureFlagDetails)\n\n        const currentFeatureFlagDetails = this.getKnownFeatureFlagDetails() || { flags: {}, requestId: undefined }\n        const newFeatureFlagDetails = {\n          flags: {\n            ...normalizedBootstrapFeatureFlagDetails.flags,\n            ...currentFeatureFlagDetails.flags,\n          },\n          requestId: normalizedBootstrapFeatureFlagDetails.requestId,\n        }\n\n        this.setKnownFeatureFlagDetails(newFeatureFlagDetails)\n      }\n    }\n  }\n\n  private clearProps(): void {\n    this.props = undefined\n    this.sessionProps = {}\n    this.flagCallReported = {}\n  }\n\n  on(event: string, cb: (...args: any[]) => void): () => void {\n    return this._events.on(event, cb)\n  }\n\n  reset(propertiesToKeep?: PostHogPersistedProperty[]): void {\n    this.wrap(() => {\n      const allPropertiesToKeep = [PostHogPersistedProperty.Queue, ...(propertiesToKeep || [])]\n\n      // clean up props\n      this.clearProps()\n\n      for (const key of <(keyof typeof PostHogPersistedProperty)[]>Object.keys(PostHogPersistedProperty)) {\n        if (!allPropertiesToKeep.includes(PostHogPersistedProperty[key])) {\n          this.setPersistedProperty((PostHogPersistedProperty as any)[key], null)\n        }\n      }\n\n      this.reloadFeatureFlags()\n    })\n  }\n\n  protected getCommonEventProperties(): PostHogEventProperties {\n    const featureFlags = this.getFeatureFlags()\n\n    const featureVariantProperties: Record<string, FeatureFlagValue> = {}\n    if (featureFlags) {\n      for (const [feature, variant] of Object.entries(featureFlags)) {\n        featureVariantProperties[`$feature/${feature}`] = variant\n      }\n    }\n    return {\n      ...maybeAdd('$active_feature_flags', featureFlags ? Object.keys(featureFlags) : undefined),\n      ...featureVariantProperties,\n      ...super.getCommonEventProperties(),\n    }\n  }\n\n  private enrichProperties(properties?: PostHogEventProperties): PostHogEventProperties {\n    return {\n      ...this.props, // Persisted properties first\n      ...this.sessionProps, // Followed by session properties\n      ...(properties || {}), // Followed by user specified properties\n      ...this.getCommonEventProperties(), // Followed by FF props\n      $session_id: this.getSessionId(),\n    }\n  }\n\n  /**\n   * Returns the current session_id.\n   *\n   * @remarks\n   * This should only be used for informative purposes.\n   * Any actual internal use case for the session_id should be handled by the sessionManager.\n   *\n   * @public\n   *\n   * @returns The stored session ID for the current session. This may be an empty string if the client is not yet fully initialized.\n   */\n  getSessionId(): string {\n    if (!this._isInitialized) {\n      return ''\n    }\n\n    let sessionId = this.getPersistedProperty<string>(PostHogPersistedProperty.SessionId)\n    const sessionLastTimestamp = this.getPersistedProperty<number>(PostHogPersistedProperty.SessionLastTimestamp) || 0\n    const sessionStartTimestamp = this.getPersistedProperty<number>(PostHogPersistedProperty.SessionStartTimestamp) || 0\n    const now = Date.now()\n    const sessionLastDif = now - sessionLastTimestamp\n    const sessionStartDif = now - sessionStartTimestamp\n    if (\n      !sessionId ||\n      sessionLastDif > this._sessionExpirationTimeSeconds * 1000 ||\n      sessionStartDif > this._sessionMaxLengthSeconds * 1000\n    ) {\n      sessionId = uuidv7()\n      this.setPersistedProperty(PostHogPersistedProperty.SessionId, sessionId)\n      this.setPersistedProperty(PostHogPersistedProperty.SessionStartTimestamp, now)\n    }\n    this.setPersistedProperty(PostHogPersistedProperty.SessionLastTimestamp, now)\n\n    return sessionId\n  }\n\n  resetSessionId(): void {\n    this.wrap(() => {\n      this.setPersistedProperty(PostHogPersistedProperty.SessionId, null)\n      this.setPersistedProperty(PostHogPersistedProperty.SessionLastTimestamp, null)\n      this.setPersistedProperty(PostHogPersistedProperty.SessionStartTimestamp, null)\n    })\n  }\n\n  /**\n   * Returns the current anonymous ID.\n   *\n   * This is the ID assigned to users before they are identified. It's used to track\n   * anonymous users and link them to identified users when they sign up.\n   *\n   * {@label Identification}\n   *\n   * @example\n   * ```js\n   * // get the anonymous ID\n   * const anonId = posthog.getAnonymousId()\n   * console.log('Anonymous ID:', anonId)\n   * ```\n   *\n   * @public\n   *\n   * @returns {string} The stored anonymous ID. This may be an empty string if the client is not yet fully initialized.\n   */\n  getAnonymousId(): string {\n    if (!this._isInitialized) {\n      return ''\n    }\n\n    let anonId = this.getPersistedProperty<string>(PostHogPersistedProperty.AnonymousId)\n    if (!anonId) {\n      anonId = uuidv7()\n      this.setPersistedProperty(PostHogPersistedProperty.AnonymousId, anonId)\n    }\n    return anonId\n  }\n\n  /**\n   * * @returns {string} The stored distinct ID. This may be an empty string if the client is not yet fully initialized.\n   */\n  getDistinctId(): string {\n    if (!this._isInitialized) {\n      return ''\n    }\n\n    return this.getPersistedProperty<string>(PostHogPersistedProperty.DistinctId) || this.getAnonymousId()\n  }\n\n  registerForSession(properties: PostHogEventProperties): void {\n    this.sessionProps = {\n      ...this.sessionProps,\n      ...properties,\n    }\n  }\n\n  unregisterForSession(property: string): void {\n    delete this.sessionProps[property]\n  }\n\n  /***\n   *** TRACKING\n   ***/\n\n  identify(distinctId?: string, properties?: PostHogEventProperties, options?: PostHogCaptureOptions): void {\n    this.wrap(() => {\n      const previousDistinctId = this.getDistinctId()\n      distinctId = distinctId || previousDistinctId\n\n      if (properties?.$groups) {\n        this.groups(properties.$groups as PostHogGroupProperties)\n      }\n\n      // promote $set and $set_once to top level\n      const userPropsOnce = properties?.$set_once\n      delete properties?.$set_once\n\n      // if no $set is provided we assume all properties are $set\n      const userProps = properties?.$set || properties\n\n      const allProperties = this.enrichProperties({\n        $anon_distinct_id: this.getAnonymousId(),\n        ...maybeAdd('$set', userProps),\n        ...maybeAdd('$set_once', userPropsOnce),\n      })\n\n      if (distinctId !== previousDistinctId) {\n        // We keep the AnonymousId to be used by flags calls and identify to link the previousId\n        this.setPersistedProperty(PostHogPersistedProperty.AnonymousId, previousDistinctId)\n        this.setPersistedProperty(PostHogPersistedProperty.DistinctId, distinctId)\n        this.reloadFeatureFlags()\n      }\n\n      super.identifyStateless(distinctId, allProperties, options)\n    })\n  }\n\n  capture(event: string, properties?: PostHogEventProperties, options?: PostHogCaptureOptions): void {\n    this.wrap(() => {\n      const distinctId = this.getDistinctId()\n\n      if (properties?.$groups) {\n        this.groups(properties.$groups as PostHogGroupProperties)\n      }\n\n      const allProperties = this.enrichProperties(properties)\n\n      super.captureStateless(distinctId, event, allProperties, options)\n    })\n  }\n\n  alias(alias: string): void {\n    this.wrap(() => {\n      const distinctId = this.getDistinctId()\n      const allProperties = this.enrichProperties({})\n\n      super.aliasStateless(alias, distinctId, allProperties)\n    })\n  }\n\n  autocapture(\n    eventType: string,\n    elements: PostHogAutocaptureElement[],\n    properties: PostHogEventProperties = {},\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      const distinctId = this.getDistinctId()\n      const payload = {\n        distinct_id: distinctId,\n        event: '$autocapture',\n        properties: {\n          ...this.enrichProperties(properties),\n          $event_type: eventType,\n          $elements: elements,\n        },\n      }\n\n      this.enqueue('autocapture', payload, options)\n    })\n  }\n\n  /***\n   *** GROUPS\n   ***/\n\n  groups(groups: PostHogGroupProperties): void {\n    this.wrap(() => {\n      // Get persisted groups\n      const existingGroups = this.props.$groups || {}\n\n      this.register({\n        $groups: {\n          ...(existingGroups as PostHogGroupProperties),\n          ...groups,\n        },\n      })\n\n      if (Object.keys(groups).find((type) => existingGroups[type as keyof typeof existingGroups] !== groups[type])) {\n        this.reloadFeatureFlags()\n      }\n    })\n  }\n\n  group(\n    groupType: string,\n    groupKey: string | number,\n    groupProperties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      this.groups({\n        [groupType]: groupKey,\n      })\n\n      if (groupProperties) {\n        this.groupIdentify(groupType, groupKey, groupProperties, options)\n      }\n    })\n  }\n\n  groupIdentify(\n    groupType: string,\n    groupKey: string | number,\n    groupProperties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      const distinctId = this.getDistinctId()\n      const eventProperties = this.enrichProperties({})\n      super.groupIdentifyStateless(groupType, groupKey, groupProperties, options, distinctId, eventProperties)\n    })\n  }\n\n  /***\n   * PROPERTIES\n   ***/\n  setPersonPropertiesForFlags(properties: { [type: string]: string }): void {\n    this.wrap(() => {\n      // Get persisted person properties\n      const existingProperties =\n        this.getPersistedProperty<Record<string, string>>(PostHogPersistedProperty.PersonProperties) || {}\n\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.PersonProperties, {\n        ...existingProperties,\n        ...properties,\n      })\n    })\n  }\n\n  resetPersonPropertiesForFlags(): void {\n    this.wrap(() => {\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.PersonProperties, null)\n    })\n  }\n\n  setGroupPropertiesForFlags(properties: { [type: string]: Record<string, string> }): void {\n    this.wrap(() => {\n      // Get persisted group properties\n      const existingProperties =\n        this.getPersistedProperty<Record<string, Record<string, string>>>(PostHogPersistedProperty.GroupProperties) ||\n        {}\n\n      if (Object.keys(existingProperties).length !== 0) {\n        Object.keys(existingProperties).forEach((groupType) => {\n          existingProperties[groupType] = {\n            ...existingProperties[groupType],\n            ...properties[groupType],\n          }\n          delete properties[groupType]\n        })\n      }\n\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.GroupProperties, {\n        ...existingProperties,\n        ...properties,\n      })\n    })\n  }\n\n  resetGroupPropertiesForFlags(): void {\n    this.wrap(() => {\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.GroupProperties, null)\n    })\n  }\n\n  private async remoteConfigAsync(): Promise<PostHogRemoteConfig | undefined> {\n    await this._initPromise\n    if (this._remoteConfigResponsePromise) {\n      return this._remoteConfigResponsePromise\n    }\n    return this._remoteConfigAsync()\n  }\n\n  /***\n   *** FEATURE FLAGS\n   ***/\n  protected async flagsAsync(\n    sendAnonDistinctId: boolean = true,\n    fetchConfig: boolean = true\n  ): Promise<PostHogFlagsResponse | undefined> {\n    await this._initPromise\n    if (this._flagsResponsePromise) {\n      return this._flagsResponsePromise\n    }\n    return this._flagsAsync(sendAnonDistinctId, fetchConfig)\n  }\n\n  private cacheSessionReplay(source: string, response?: PostHogRemoteConfig): void {\n    const sessionReplay = response?.sessionRecording\n    if (sessionReplay) {\n      this.setPersistedProperty(PostHogPersistedProperty.SessionReplay, sessionReplay)\n      this._logger.info(`Session replay config from ${source}: `, JSON.stringify(sessionReplay))\n    } else if (typeof sessionReplay === 'boolean' && sessionReplay === false) {\n      // if session replay is disabled, we don't need to cache it\n      // we need to check for this because the response might be undefined (/flags does not return sessionRecording yet)\n      this._logger.info(`Session replay config from ${source} disabled.`)\n      this.setPersistedProperty(PostHogPersistedProperty.SessionReplay, null)\n    }\n  }\n\n  private async _remoteConfigAsync(): Promise<PostHogRemoteConfig | undefined> {\n    this._remoteConfigResponsePromise = this._initPromise\n      .then(() => {\n        let remoteConfig = this.getPersistedProperty<Omit<PostHogRemoteConfig, 'surveys'>>(\n          PostHogPersistedProperty.RemoteConfig\n        )\n\n        this._logger.info('Cached remote config: ', JSON.stringify(remoteConfig))\n\n        return super.getRemoteConfig().then((response) => {\n          if (response) {\n            const remoteConfigWithoutSurveys = { ...response }\n            delete remoteConfigWithoutSurveys.surveys\n\n            this._logger.info('Fetched remote config: ', JSON.stringify(remoteConfigWithoutSurveys))\n\n            if (this.disableSurveys === false) {\n              const surveys = response.surveys\n\n              let hasSurveys = true\n\n              if (!Array.isArray(surveys)) {\n                // If surveys is not an array, it means there are no surveys (its a boolean instead)\n                this._logger.info('There are no surveys.')\n                hasSurveys = false\n              } else {\n                this._logger.info('Surveys fetched from remote config: ', JSON.stringify(surveys))\n              }\n\n              if (hasSurveys) {\n                this.setPersistedProperty<SurveyResponse['surveys']>(\n                  PostHogPersistedProperty.Surveys,\n                  surveys as Survey[]\n                )\n              } else {\n                this.setPersistedProperty<SurveyResponse['surveys']>(PostHogPersistedProperty.Surveys, null)\n              }\n            } else {\n              this.setPersistedProperty<SurveyResponse['surveys']>(PostHogPersistedProperty.Surveys, null)\n            }\n            // we cache the surveys in its own storage key\n            this.setPersistedProperty<Omit<PostHogRemoteConfig, 'surveys'>>(\n              PostHogPersistedProperty.RemoteConfig,\n              remoteConfigWithoutSurveys\n            )\n\n            this.cacheSessionReplay('remote config', response)\n\n            // we only dont load flags if the remote config has no feature flags\n            if (response.hasFeatureFlags === false) {\n              // resetting flags to empty object\n              this.setKnownFeatureFlagDetails({ flags: {} })\n\n              this._logger.warn('Remote config has no feature flags, will not load feature flags.')\n            } else if (this.preloadFeatureFlags !== false) {\n              this.reloadFeatureFlags()\n            }\n\n            if (!response.supportedCompression?.includes(Compression.GZipJS)) {\n              this.disableCompression = true\n            }\n\n            remoteConfig = response\n          }\n\n          return remoteConfig\n        })\n      })\n      .finally(() => {\n        this._remoteConfigResponsePromise = undefined\n      })\n    return this._remoteConfigResponsePromise\n  }\n\n  private async _flagsAsync(\n    sendAnonDistinctId: boolean = true,\n    fetchConfig: boolean = true\n  ): Promise<PostHogFlagsResponse | undefined> {\n    this._flagsResponsePromise = this._initPromise\n      .then(async () => {\n        const distinctId = this.getDistinctId()\n        const groups = this.props.$groups || {}\n        const personProperties =\n          this.getPersistedProperty<Record<string, string>>(PostHogPersistedProperty.PersonProperties) || {}\n        const groupProperties =\n          this.getPersistedProperty<Record<string, Record<string, string>>>(PostHogPersistedProperty.GroupProperties) ||\n          {}\n\n        const extraProperties = {\n          $anon_distinct_id: sendAnonDistinctId ? this.getAnonymousId() : undefined,\n        }\n\n        const res = await super.getFlags(\n          distinctId,\n          groups as PostHogGroupProperties,\n          personProperties,\n          groupProperties,\n          extraProperties,\n          fetchConfig\n        )\n        // Add check for quota limitation on feature flags\n        if (res?.quotaLimited?.includes(QuotaLimitedFeature.FeatureFlags)) {\n          // Unset all feature flags by setting to null\n          this.setKnownFeatureFlagDetails(null)\n          console.warn(\n            '[FEATURE FLAGS] Feature flags quota limit exceeded - unsetting all flags. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts'\n          )\n          return res\n        }\n        if (res?.featureFlags) {\n          // clear flag call reported if we have new flags since they might have changed\n          if (this.sendFeatureFlagEvent) {\n            this.flagCallReported = {}\n          }\n\n          let newFeatureFlagDetails = res\n          if (res.errorsWhileComputingFlags) {\n            // if not all flags were computed, we upsert flags instead of replacing them\n            const currentFlagDetails = this.getKnownFeatureFlagDetails()\n            this._logger.info('Cached feature flags: ', JSON.stringify(currentFlagDetails))\n\n            newFeatureFlagDetails = {\n              ...res,\n              flags: { ...currentFlagDetails?.flags, ...res.flags },\n            }\n          }\n          this.setKnownFeatureFlagDetails(newFeatureFlagDetails)\n          // Mark that we hit the /flags endpoint so we can capture this in the $feature_flag_called event\n          this.setPersistedProperty(PostHogPersistedProperty.FlagsEndpointWasHit, true)\n          this.cacheSessionReplay('flags', res)\n        }\n        return res\n      })\n      .finally(() => {\n        this._flagsResponsePromise = undefined\n      })\n    return this._flagsResponsePromise\n  }\n\n  // We only store the flags and request id in the feature flag details storage key\n  private setKnownFeatureFlagDetails(flagsResponse: PostHogFlagsStorageFormat | null): void {\n    this.wrap(() => {\n      this.setPersistedProperty<PostHogFlagsStorageFormat>(PostHogPersistedProperty.FeatureFlagDetails, flagsResponse)\n\n      this._events.emit('featureflags', getFlagValuesFromFlags(flagsResponse?.flags ?? {}))\n    })\n  }\n\n  private getKnownFeatureFlagDetails(): PostHogFeatureFlagDetails | undefined {\n    const storedDetails = this.getPersistedProperty<PostHogFlagsStorageFormat>(\n      PostHogPersistedProperty.FeatureFlagDetails\n    )\n    if (!storedDetails) {\n      // Rebuild from the stored feature flags and feature flag payloads\n      const featureFlags = this.getPersistedProperty<PostHogFlagsResponse['featureFlags']>(\n        PostHogPersistedProperty.FeatureFlags\n      )\n      const featureFlagPayloads = this.getPersistedProperty<PostHogFlagsResponse['featureFlagPayloads']>(\n        PostHogPersistedProperty.FeatureFlagPayloads\n      )\n\n      if (featureFlags === undefined && featureFlagPayloads === undefined) {\n        return undefined\n      }\n\n      return createFlagsResponseFromFlagsAndPayloads(featureFlags ?? {}, featureFlagPayloads ?? {})\n    }\n\n    return normalizeFlagsResponse(\n      storedDetails as PostHogV1FlagsResponse | PostHogV2FlagsResponse\n    ) as PostHogFeatureFlagDetails\n  }\n\n  protected getKnownFeatureFlags(): PostHogFlagsResponse['featureFlags'] | undefined {\n    const featureFlagDetails = this.getKnownFeatureFlagDetails()\n    if (!featureFlagDetails) {\n      return undefined\n    }\n    return getFlagValuesFromFlags(featureFlagDetails.flags)\n  }\n\n  private getKnownFeatureFlagPayloads(): PostHogFlagsResponse['featureFlagPayloads'] | undefined {\n    const featureFlagDetails = this.getKnownFeatureFlagDetails()\n    if (!featureFlagDetails) {\n      return undefined\n    }\n    return getPayloadsFromFlags(featureFlagDetails.flags)\n  }\n\n  private getBootstrappedFeatureFlagDetails(): PostHogFeatureFlagDetails | undefined {\n    const details = this.getPersistedProperty<PostHogFeatureFlagDetails>(\n      PostHogPersistedProperty.BootstrapFeatureFlagDetails\n    )\n    if (!details) {\n      return undefined\n    }\n    return details\n  }\n\n  private setBootstrappedFeatureFlagDetails(details: PostHogFeatureFlagDetails): void {\n    this.setPersistedProperty<PostHogFeatureFlagDetails>(PostHogPersistedProperty.BootstrapFeatureFlagDetails, details)\n  }\n\n  private getBootstrappedFeatureFlags(): PostHogFlagsResponse['featureFlags'] | undefined {\n    const details = this.getBootstrappedFeatureFlagDetails()\n    if (!details) {\n      return undefined\n    }\n    return getFlagValuesFromFlags(details.flags)\n  }\n\n  private getBootstrappedFeatureFlagPayloads(): PostHogFlagsResponse['featureFlagPayloads'] | undefined {\n    const details = this.getBootstrappedFeatureFlagDetails()\n    if (!details) {\n      return undefined\n    }\n    return getPayloadsFromFlags(details.flags)\n  }\n\n  getFeatureFlag(key: string): FeatureFlagValue | undefined {\n    const details = this.getFeatureFlagDetails()\n\n    if (!details) {\n      // If we haven't loaded flags yet, or errored out, we respond with undefined\n      return undefined\n    }\n\n    const featureFlag = details.flags[key]\n\n    let response = getFeatureFlagValue(featureFlag)\n\n    if (response === undefined) {\n      // For cases where the flag is unknown, return false\n      response = false\n    }\n\n    if (this.sendFeatureFlagEvent && !this.flagCallReported[key]) {\n      const bootstrappedResponse = this.getBootstrappedFeatureFlags()?.[key]\n      const bootstrappedPayload = this.getBootstrappedFeatureFlagPayloads()?.[key]\n\n      this.flagCallReported[key] = true\n      this.capture('$feature_flag_called', {\n        $feature_flag: key,\n        $feature_flag_response: response,\n        ...maybeAdd('$feature_flag_id', featureFlag?.metadata?.id),\n        ...maybeAdd('$feature_flag_version', featureFlag?.metadata?.version),\n        ...maybeAdd('$feature_flag_reason', featureFlag?.reason?.description ?? featureFlag?.reason?.code),\n        ...maybeAdd('$feature_flag_bootstrapped_response', bootstrappedResponse),\n        ...maybeAdd('$feature_flag_bootstrapped_payload', bootstrappedPayload),\n        // If we haven't yet received a response from the /flags endpoint, we must have used the bootstrapped value\n        $used_bootstrap_value: !this.getPersistedProperty(PostHogPersistedProperty.FlagsEndpointWasHit),\n        ...maybeAdd('$feature_flag_request_id', details.requestId),\n      })\n    }\n\n    // If we have flags we either return the value (true or string) or false\n    return response\n  }\n\n  getFeatureFlagPayload(key: string): JsonType | undefined {\n    const payloads = this.getFeatureFlagPayloads()\n\n    if (!payloads) {\n      return undefined\n    }\n\n    const response = payloads[key]\n\n    // Undefined means a loading or missing data issue. Null means evaluation happened and there was no match\n    if (response === undefined) {\n      return null\n    }\n\n    return response\n  }\n\n  getFeatureFlagPayloads(): PostHogFlagsResponse['featureFlagPayloads'] | undefined {\n    return this.getFeatureFlagDetails()?.featureFlagPayloads\n  }\n\n  getFeatureFlags(): PostHogFlagsResponse['featureFlags'] | undefined {\n    // NOTE: We don't check for _initPromise here as the function is designed to be\n    // callable before the state being loaded anyways\n    return this.getFeatureFlagDetails()?.featureFlags\n  }\n\n  getFeatureFlagDetails(): PostHogFeatureFlagDetails | undefined {\n    // NOTE: We don't check for _initPromise here as the function is designed to be\n    // callable before the state being loaded anyways\n    let details = this.getKnownFeatureFlagDetails()\n    const overriddenFlags = this.getPersistedProperty<PostHogFlagsResponse['featureFlags']>(\n      PostHogPersistedProperty.OverrideFeatureFlags\n    )\n\n    if (!overriddenFlags) {\n      return details\n    }\n\n    details = details ?? { featureFlags: {}, featureFlagPayloads: {}, flags: {} }\n\n    const flags: Record<string, FeatureFlagDetail> = details.flags ?? {}\n\n    for (const key in overriddenFlags) {\n      if (!overriddenFlags[key]) {\n        delete flags[key]\n      } else {\n        flags[key] = updateFlagValue(flags[key], overriddenFlags[key])\n      }\n    }\n\n    const result = {\n      ...details,\n      flags,\n    }\n\n    return normalizeFlagsResponse(result) as PostHogFeatureFlagDetails\n  }\n\n  getFeatureFlagsAndPayloads(): {\n    flags: PostHogFlagsResponse['featureFlags'] | undefined\n    payloads: PostHogFlagsResponse['featureFlagPayloads'] | undefined\n  } {\n    const flags = this.getFeatureFlags()\n    const payloads = this.getFeatureFlagPayloads()\n\n    return {\n      flags,\n      payloads,\n    }\n  }\n\n  isFeatureEnabled(key: string): boolean | undefined {\n    const response = this.getFeatureFlag(key)\n    if (response === undefined) {\n      return undefined\n    }\n    return !!response\n  }\n\n  // Used when we want to trigger the reload but we don't care about the result\n  reloadFeatureFlags(options?: { cb?: (err?: Error, flags?: PostHogFlagsResponse['featureFlags']) => void }): void {\n    this.flagsAsync(true)\n      .then((res) => {\n        options?.cb?.(undefined, res?.featureFlags)\n      })\n      .catch((e) => {\n        options?.cb?.(e, undefined)\n        if (!options?.cb) {\n          this._logger.info('Error reloading feature flags', e)\n        }\n      })\n  }\n\n  async reloadRemoteConfigAsync(): Promise<PostHogRemoteConfig | undefined> {\n    return await this.remoteConfigAsync()\n  }\n\n  async reloadFeatureFlagsAsync(\n    sendAnonDistinctId?: boolean\n  ): Promise<PostHogFlagsResponse['featureFlags'] | undefined> {\n    return (await this.flagsAsync(sendAnonDistinctId ?? true))?.featureFlags\n  }\n\n  onFeatureFlags(cb: (flags: PostHogFlagsResponse['featureFlags']) => void): () => void {\n    return this.on('featureflags', async () => {\n      const flags = this.getFeatureFlags()\n      if (flags) {\n        cb(flags)\n      }\n    })\n  }\n\n  onFeatureFlag(key: string, cb: (value: FeatureFlagValue) => void): () => void {\n    return this.on('featureflags', async () => {\n      const flagResponse = this.getFeatureFlag(key)\n      if (flagResponse !== undefined) {\n        cb(flagResponse)\n      }\n    })\n  }\n\n  async overrideFeatureFlag(flags: PostHogFlagsResponse['featureFlags'] | null): Promise<void> {\n    this.wrap(() => {\n      if (flags === null) {\n        return this.setPersistedProperty(PostHogPersistedProperty.OverrideFeatureFlags, null)\n      }\n      return this.setPersistedProperty(PostHogPersistedProperty.OverrideFeatureFlags, flags)\n    })\n  }\n\n  /**\n   * Capture a caught exception manually\n   *\n   * {@label Error tracking}\n   *\n   * @public\n   *\n   * @example\n   * ```js\n   * // Capture a caught exception\n   * try {\n   *   // something that might throw\n   * } catch (error) {\n   *   posthog.captureException(error)\n   * }\n   * ```\n   *\n   * @example\n   * ```js\n   * // With additional properties\n   * posthog.captureException(error, {\n   *   customProperty: 'value',\n   *   anotherProperty: ['I', 'can be a list'],\n   *   ...\n   * })\n   * ```\n   *\n   * @param {Error} error The error to capture\n   * @param {Object} [additionalProperties] Any additional properties to add to the error event\n   * @returns {CaptureResult} The result of the capture\n   */\n  captureException(error: unknown, additionalProperties?: PostHogEventProperties): void {\n    const properties: { [key: string]: any } = {\n      $exception_level: 'error',\n      $exception_list: [\n        {\n          type: isPlainError(error) ? error.name : 'Error',\n          value: isPlainError(error) ? error.message : error,\n          mechanism: {\n            handled: true,\n            synthetic: false,\n          },\n        },\n      ],\n      ...additionalProperties,\n    }\n\n    this.capture('$exception', properties)\n  }\n\n  /**\n   * Capture written user feedback for a LLM trace. Numeric values are converted to strings.\n   *\n   * {@label LLM analytics}\n   *\n   * @public\n   *\n   * @param traceId The trace ID to capture feedback for.\n   * @param userFeedback The feedback to capture.\n   */\n  captureTraceFeedback(traceId: string | number, userFeedback: string): void {\n    this.capture('$ai_feedback', {\n      $ai_feedback_text: userFeedback,\n      $ai_trace_id: String(traceId),\n    })\n  }\n\n  /**\n   * Capture a metric for a LLM trace. Numeric values are converted to strings.\n   *\n   * {@label LLM analytics}\n   *\n   * @public\n   *\n   * @param traceId The trace ID to capture the metric for.\n   * @param metricName The name of the metric to capture.\n   * @param metricValue The value of the metric to capture.\n   */\n  captureTraceMetric(traceId: string | number, metricName: string, metricValue: string | number | boolean): void {\n    this.capture('$ai_metric', {\n      $ai_metric_name: metricName,\n      $ai_metric_value: String(metricValue),\n      $ai_trace_id: String(traceId),\n    })\n  }\n}\n"]}