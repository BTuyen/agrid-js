{"version":3,"file":"posthog-core-stateless.js","sourceRoot":"","sources":["posthog-core-stateless.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyEA,sCAYC;AArFD,+CAAmD;AACnD,uDAAgF;AAChF,+BAAsD;AACtD,mCAAuC;AACvC,iCAkBgB;AAChB,iCAUgB;AAChB,0CAAwC;AAExC;IAAoC,yCAAK;IAGvC,+BACS,QAA8B,EAC9B,aAAqB;QAE5B,YAAA,MAAK,YAAC,4CAA4C,GAAG,QAAQ,CAAC,MAAM,GAAG,kBAAkB,GAAG,aAAa,CAAC,SAAA;QAHnG,cAAQ,GAAR,QAAQ,CAAsB;QAC9B,mBAAa,GAAb,aAAa,CAAQ;QAJ9B,UAAI,GAAG,uBAAuB,CAAA;;IAO9B,CAAC;IAED,sBAAI,yCAAM;aAAV;YACE,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAA;QAC7B,CAAC;;;OAAA;IAED,sBAAI,uCAAI;aAAR;YACE,OAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAA;QAC7B,CAAC;;;OAAA;IAED,sBAAI,uCAAI;aAAR;YACE,OAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAA;QAC7B,CAAC;;;OAAA;IACH,4BAAC;AAAD,CAAC,AArBD,CAAoC,KAAK,GAqBxC;AAED;IAAuC,4CAAK;IAG1C,kCAAmB,KAAc;QAC/B,2GAA2G;QAC3G,qEAAqE;QACrE,aAAa;QACb,YAAA,MAAK,YAAC,sCAAsC,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,SAAA;QAJ5E,WAAK,GAAL,KAAK,CAAS;QAFjC,UAAI,GAAG,0BAA0B,CAAA;;IAOjC,CAAC;IACH,+BAAC;AAAD,CAAC,AATD,CAAuC,KAAK,GAS3C;AAEM,IAAM,QAAQ,GAAG,UAAC,GAAW,EAAE,KAA2B;;IAC/D,OAAA,KAAK,KAAK,SAAS,CAAC,CAAC,WAAG,GAAC,GAAG,IAAG,KAAK,MAAG,CAAC,CAAC,EAAE;AAA3C,CAA2C,CAAA;AADhC,QAAA,QAAQ,YACwB;AAE7C,SAAsB,aAAa,CAAC,GAAQ;;;;;;yBACtC,CAAA,GAAG,YAAY,qBAAqB,CAAA,EAApC,wBAAoC;oBAClC,IAAI,GAAG,EAAE,CAAA;;;;oBAEJ,qBAAM,GAAG,CAAC,IAAI,EAAA;;oBAArB,IAAI,GAAG,SAAc,CAAA;;;;;;oBAGvB,OAAO,CAAC,KAAK,CAAC,gDAAyC,GAAG,CAAC,OAAO,6BAAmB,IAAI,CAAE,EAAE,GAAG,CAAC,CAAA;;;oBAEjG,OAAO,CAAC,KAAK,CAAC,8BAA8B,EAAE,GAAG,CAAC,CAAA;;wBAEpD,sBAAO,OAAO,CAAC,OAAO,EAAE,EAAA;;;;CACzB;AAED,SAAS,mBAAmB,CAAC,GAAY;IACvC,OAAO,OAAO,GAAG,KAAK,QAAQ,IAAI,CAAC,GAAG,YAAY,qBAAqB,IAAI,GAAG,YAAY,wBAAwB,CAAC,CAAA;AACrH,CAAC;AAED,SAAS,kCAAkC,CAAC,GAAY;IACtD,OAAO,OAAO,GAAG,KAAK,QAAQ,IAAI,GAAG,YAAY,qBAAqB,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,CAAA;AAC9F,CAAC;AAED,IAAY,mBAGX;AAHD,WAAY,mBAAmB;IAC7B,qDAA8B,CAAA;IAC9B,gDAAyB,CAAA;AAC3B,CAAC,EAHW,mBAAmB,mCAAnB,mBAAmB,QAG9B;AAED;IA4CE,8BAAY,MAAc,EAAE,OAAgC;QAAhC,wBAAA,EAAA,YAAgC;;QAlCpD,iBAAY,GAAwB,IAAI,CAAA;QACxC,oBAAe,GAAyB,IAAI,CAAA;QAY5C,iBAAY,GAAiB,IAAI,oBAAY,EAAE,CAAA;QAEvD,WAAW;QACD,YAAO,GAAG,IAAI,iCAAkB,EAAE,CAAA;QAIlC,mBAAc,GAAY,KAAK,CAAA;QAevC,IAAA,cAAM,EAAC,MAAM,EAAE,+CAA+C,CAAC,CAAA;QAE/D,IAAI,CAAC,MAAM,GAAG,MAAM,CAAA;QACpB,IAAI,CAAC,IAAI,GAAG,IAAA,2BAAmB,EAAC,OAAO,CAAC,IAAI,IAAI,0BAA0B,CAAC,CAAA;QAC3E,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAA;QAClE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,MAAA,OAAO,CAAC,YAAY,mCAAI,GAAG,CAAC,CAAA;QACvE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE,MAAA,OAAO,CAAC,YAAY,mCAAI,IAAI,CAAC,CAAA;QACxE,IAAI,CAAC,aAAa,GAAG,MAAA,OAAO,CAAC,aAAa,mCAAI,KAAK,CAAA;QACnD,IAAI,CAAC,mBAAmB,GAAG,MAAA,OAAO,CAAC,mBAAmB,mCAAI,IAAI,CAAA;QAC9D,8DAA8D;QAC9D,IAAI,CAAC,YAAY,GAAG,MAAA,OAAO,CAAC,YAAY,mCAAI,IAAI,CAAA;QAChD,IAAI,CAAC,cAAc,GAAG,MAAA,OAAO,CAAC,cAAc,mCAAI,KAAK,CAAA;QAErD,IAAI,CAAC,aAAa,GAAG;YACnB,UAAU,EAAE,MAAA,OAAO,CAAC,eAAe,mCAAI,CAAC;YACxC,UAAU,EAAE,MAAA,OAAO,CAAC,eAAe,mCAAI,IAAI,EAAE,YAAY;YACzD,UAAU,EAAE,mBAAmB;SAChC,CAAA;QACD,IAAI,CAAC,cAAc,GAAG,MAAA,OAAO,CAAC,cAAc,mCAAI,KAAK,CAAA,CAAC,aAAa;QACnE,IAAI,CAAC,4BAA4B,GAAG,MAAA,OAAO,CAAC,4BAA4B,mCAAI,IAAI,CAAA,CAAC,YAAY;QAC7F,IAAI,CAAC,4BAA4B,GAAG,MAAA,OAAO,CAAC,4BAA4B,mCAAI,IAAI,CAAA,CAAC,YAAY;QAC7F,IAAI,CAAC,YAAY,GAAG,MAAA,OAAO,CAAC,YAAY,mCAAI,IAAI,CAAA;QAChD,IAAI,CAAC,QAAQ,GAAG,MAAA,OAAO,CAAC,QAAQ,mCAAI,KAAK,CAAA;QACzC,IAAI,CAAC,mBAAmB,GAAG,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,mBAAmB,mCAAI,KAAK,CAAA;QAChE,IAAI,CAAC,sBAAsB,GAAG,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,sBAAsB,CAAA;QAC7D,yEAAyE;QACzE,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,OAAO,EAAE,CAAA;QACrC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAA;QAC1B,IAAI,CAAC,OAAO,GAAG,IAAA,qBAAY,EAAC,WAAW,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAA;QACvE,IAAI,CAAC,kBAAkB,GAAG,CAAC,IAAA,sBAAe,GAAE,IAAI,CAAC,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,kBAAkB,mCAAI,KAAK,CAAC,CAAA;IACxF,CAAC;IAES,4CAAa,GAAvB,UAAwB,EAAc;QACpC,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,EAAE,EAAE,CAAA;QACN,CAAC;IACH,CAAC;IAES,mCAAI,GAAd,UAAe,EAAc;QAC3B,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAA;YAC3C,OAAM;QACR,CAAC;QAED,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;YACxB,4DAA4D;YAC5D,OAAO,EAAE,EAAE,CAAA;QACb,CAAC;QAED,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,cAAM,OAAA,EAAE,EAAE,EAAJ,CAAI,CAAC,CAAA;IACpC,CAAC;IAES,uDAAwB,GAAlC;QACE,OAAO;YACL,IAAI,EAAE,IAAI,CAAC,YAAY,EAAE;YACzB,YAAY,EAAE,IAAI,CAAC,iBAAiB,EAAE;SACvC,CAAA;IACH,CAAC;IAED,sBAAW,0CAAQ;aAAnB;;YACE,OAAO,MAAA,IAAI,CAAC,oBAAoB,CAAC,gCAAwB,CAAC,QAAQ,CAAC,mCAAI,CAAC,IAAI,CAAC,YAAY,CAAA;QAC3F,CAAC;;;OAAA;IAEK,oCAAK,GAAX;;;;gBACE,IAAI,CAAC,IAAI,CAAC;oBACR,KAAI,CAAC,oBAAoB,CAAC,gCAAwB,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAA;gBACrE,CAAC,CAAC,CAAA;;;;KACH;IAEK,qCAAM,GAAZ;;;;gBACE,IAAI,CAAC,IAAI,CAAC;oBACR,KAAI,CAAC,oBAAoB,CAAC,gCAAwB,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAA;gBACpE,CAAC,CAAC,CAAA;;;;KACH;IAED,iCAAE,GAAF,UAAG,KAAa,EAAE,EAA4B;QAC5C,OAAO,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC,CAAA;IACnC,CAAC;IAED;;;;;;;;;;;;;;;;;;;;;;;;OAwBG;IACH,oCAAK,GAAL,UAAM,OAAuB;QAA7B,iBAUC;;QAVK,wBAAA,EAAA,cAAuB;QAC3B,MAAA,IAAI,CAAC,mBAAmB,oDAAI,CAAA;QAE5B,IAAI,OAAO,EAAE,CAAC;YACZ,IAAM,qBAAmB,GAAG,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,UAAC,KAAK,EAAE,OAAO,IAAK,OAAA,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,OAAO,CAAC,EAAjC,CAAiC,CAAC,CAAA;YAC/F,IAAI,CAAC,mBAAmB,GAAG;gBACzB,qBAAmB,EAAE,CAAA;gBACrB,KAAI,CAAC,mBAAmB,GAAG,SAAS,CAAA;YACtC,CAAC,CAAA;QACH,CAAC;IACH,CAAC;IAED,sBAAI,yCAAO;aAAX;YACE,OAAO,CAAC,CAAC,IAAI,CAAC,mBAAmB,CAAA;QACnC,CAAC;;;OAAA;IAED,sBAAI,4CAAU;aAAd;YACE,OAAO,IAAI,CAAC,QAAQ,CAAA;QACtB,CAAC;;;OAAA;IAEO,2CAAY,GAApB,UAAqB,OAIpB;QACC,OAAO;YACL,WAAW,EAAE,OAAO,CAAC,WAAW;YAChC,KAAK,EAAE,OAAO,CAAC,KAAK;YACpB,UAAU,wBACL,CAAC,OAAO,CAAC,UAAU,IAAI,EAAE,CAAC,GAC1B,IAAI,CAAC,wBAAwB,EAAE,CACnC;SACF,CAAA;IACH,CAAC;IAEM,gDAAiB,GAAxB,UAA4B,OAAmB;QAC7C,OAAO,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;IACvC,CAAC;IAED;;SAEK;IACK,gDAAiB,GAA3B,UACE,UAAkB,EAClB,UAAmC,EACnC,OAA+B;QAHjC,iBAmBC;QAdC,IAAI,CAAC,IAAI,CAAC;YACR,mEAAmE;YACnE,8FAA8F;YAE9F,IAAM,OAAO,gBACR,KAAI,CAAC,YAAY,CAAC;gBACnB,WAAW,EAAE,UAAU;gBACvB,KAAK,EAAE,WAAW;gBAClB,UAAU,YAAA;aACX,CAAC,CACH,CAAA;YAED,KAAI,CAAC,OAAO,CAAC,UAAU,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;QAC5C,CAAC,CAAC,CAAA;IACJ,CAAC;IAEe,yDAA0B,GAA1C,UACE,UAAkB,EAClB,UAAmC,EACnC,OAA+B;;;;;;wBAEzB,OAAO,gBACR,IAAI,CAAC,YAAY,CAAC;4BACnB,WAAW,EAAE,UAAU;4BACvB,KAAK,EAAE,WAAW;4BAClB,UAAU,YAAA;yBACX,CAAC,CACH,CAAA;wBAED,qBAAM,IAAI,CAAC,aAAa,CAAC,UAAU,EAAE,OAAO,EAAE,OAAO,CAAC,EAAA;;wBAAtD,SAAsD,CAAA;;;;;KACvD;IAES,+CAAgB,GAA1B,UACE,UAAkB,EAClB,KAAa,EACb,UAAmC,EACnC,OAA+B;QAJjC,iBAUC;QAJC,IAAI,CAAC,IAAI,CAAC;YACR,IAAM,OAAO,GAAG,KAAI,CAAC,YAAY,CAAC,EAAE,WAAW,EAAE,UAAU,EAAE,KAAK,OAAA,EAAE,UAAU,YAAA,EAAE,CAAC,CAAA;YACjF,KAAI,CAAC,OAAO,CAAC,SAAS,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;QAC3C,CAAC,CAAC,CAAA;IACJ,CAAC;IAEe,wDAAyB,GAAzC,UACE,UAAkB,EAClB,KAAa,EACb,UAAmC,EACnC,OAA+B;;;;;;wBAEzB,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,EAAE,WAAW,EAAE,UAAU,EAAE,KAAK,OAAA,EAAE,UAAU,YAAA,EAAE,CAAC,CAAA;wBACjF,qBAAM,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE,OAAO,EAAE,OAAO,CAAC,EAAA;;wBAArD,SAAqD,CAAA;;;;;KACtD;IAES,6CAAc,GAAxB,UACE,KAAa,EACb,UAAkB,EAClB,UAAmC,EACnC,OAA+B;QAJjC,iBAmBC;QAbC,IAAI,CAAC,IAAI,CAAC;YACR,IAAM,OAAO,GAAG,KAAI,CAAC,YAAY,CAAC;gBAChC,KAAK,EAAE,eAAe;gBACtB,WAAW,EAAE,UAAU;gBACvB,UAAU,wBACL,CAAC,UAAU,IAAI,EAAE,CAAC,KACrB,WAAW,EAAE,UAAU,EACvB,KAAK,OAAA,GACN;aACF,CAAC,CAAA;YAEF,KAAI,CAAC,OAAO,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;QACzC,CAAC,CAAC,CAAA;IACJ,CAAC;IAEe,sDAAuB,GAAvC,UACE,KAAa,EACb,UAAkB,EAClB,UAAmC,EACnC,OAA+B;;;;;;wBAEzB,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC;4BAChC,KAAK,EAAE,eAAe;4BACtB,WAAW,EAAE,UAAU;4BACvB,UAAU,wBACL,CAAC,UAAU,IAAI,EAAE,CAAC,KACrB,WAAW,EAAE,UAAU,EACvB,KAAK,OAAA,GACN;yBACF,CAAC,CAAA;wBAEF,qBAAM,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,EAAA;;wBAAnD,SAAmD,CAAA;;;;;KACpD;IAED;;SAEK;IACK,qDAAsB,GAAhC,UACE,SAAiB,EACjB,QAAyB,EACzB,eAAwC,EACxC,OAA+B,EAC/B,UAAmB,EACnB,eAAwC;QAN1C,iBAsBC;QAdC,IAAI,CAAC,IAAI,CAAC;YACR,IAAM,OAAO,GAAG,KAAI,CAAC,YAAY,CAAC;gBAChC,WAAW,EAAE,UAAU,IAAI,WAAI,SAAS,cAAI,QAAQ,CAAE;gBACtD,KAAK,EAAE,gBAAgB;gBACvB,UAAU,aACR,WAAW,EAAE,SAAS,EACtB,UAAU,EAAE,QAAQ,EACpB,UAAU,EAAE,eAAe,IAAI,EAAE,IAC9B,CAAC,eAAe,IAAI,EAAE,CAAC,CAC3B;aACF,CAAC,CAAA;YAEF,KAAI,CAAC,OAAO,CAAC,SAAS,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;QAC3C,CAAC,CAAC,CAAA;IACJ,CAAC;IAEe,8CAAe,GAA/B;;;;;;4BACE,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEnB,IAAI,GAAG,IAAI,CAAC,IAAI,CAAA;wBAEpB,IAAI,IAAI,KAAK,0BAA0B,EAAE,CAAC;4BACxC,IAAI,GAAG,iCAAiC,CAAA;wBAC1C,CAAC;6BAAM,IAAI,IAAI,KAAK,0BAA0B,EAAE,CAAC;4BAC/C,IAAI,GAAG,iCAAiC,CAAA;wBAC1C,CAAC;wBAEK,GAAG,GAAG,UAAG,IAAI,oBAAU,IAAI,CAAC,MAAM,YAAS,CAAA;wBAC3C,YAAY,GAAwB;4BACxC,MAAM,EAAE,KAAK;4BACb,OAAO,wBAAO,IAAI,CAAC,gBAAgB,EAAE,KAAE,cAAc,EAAE,kBAAkB,GAAE;yBAC5E,CAAA;wBACD,sCAAsC;wBACtC,sBAAO,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,YAAY,EAAE,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,IAAI,CAAC,4BAA4B,CAAC;iCAChG,IAAI,CAAC,UAAC,QAAQ,IAAK,OAAA,QAAQ,CAAC,IAAI,EAAkC,EAA/C,CAA+C,CAAC;iCACnE,KAAK,CAAC,UAAC,KAAK;gCACX,KAAI,CAAC,OAAO,CAAC,KAAK,CAAC,mCAAmC,EAAE,KAAK,CAAC,CAAA;gCAC9D,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;gCACjC,OAAO,SAAS,CAAA;4BAClB,CAAC,CAAC,EAAA;;;;KACL;IAED;;SAEK;IAEW,uCAAQ,GAAxB;4DACE,UAAkB,EAClB,MAA4C,EAC5C,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsC,EACtC,WAA2B;;;YAJ3B,uBAAA,EAAA,WAA4C;YAC5C,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;YAC5D,6BAAA,EAAA,iBAAsC;YACtC,4BAAA,EAAA,kBAA2B;;;4BAE3B,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEjB,WAAW,GAAG,WAAW,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,EAAE,CAAA;wBAC/C,GAAG,GAAG,UAAG,IAAI,CAAC,IAAI,wBAAc,WAAW,CAAE,CAAA;wBAC7C,WAAW,cACf,KAAK,EAAE,IAAI,CAAC,MAAM,EAClB,WAAW,EAAE,UAAU,EACvB,MAAM,QAAA,EACN,iBAAiB,EAAE,gBAAgB,EACnC,gBAAgB,EAAE,eAAe,IAC9B,YAAY,CAChB,CAAA;wBAED,4CAA4C;wBAC5C,IAAI,IAAI,CAAC,sBAAsB,IAAI,IAAI,CAAC,sBAAsB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4BAC1E,WAAW,CAAC,uBAAuB,GAAG,IAAI,CAAC,sBAAsB,CAAA;wBACnE,CAAC;wBAEK,YAAY,GAAwB;4BACxC,MAAM,EAAE,MAAM;4BACd,OAAO,wBAAO,IAAI,CAAC,gBAAgB,EAAE,KAAE,cAAc,EAAE,kBAAkB,GAAE;4BAC3E,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC;yBAClC,CAAA;wBAED,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,EAAE,GAAG,CAAC,CAAA;wBAEnC,+BAA+B;wBAC/B,sBAAO,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,YAAY,EAAE,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,IAAI,CAAC,4BAA4B,CAAC;iCAChG,IAAI,CAAC,UAAC,QAAQ,IAAK,OAAA,QAAQ,CAAC,IAAI,EAA8D,EAA3E,CAA2E,CAAC;iCAC/F,IAAI,CAAC,UAAC,QAAQ,IAAK,OAAA,IAAA,yCAAsB,EAAC,QAAQ,CAAC,EAAhC,CAAgC,CAAC;iCACpD,KAAK,CAAC,UAAC,KAAK;gCACX,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;gCACjC,OAAO,SAAS,CAAA;4BAClB,CAAC,CAA8C,EAAA;;;;KAClD;IAEe,sDAAuB,GAAvC;4DACE,GAAW,EACX,UAAkB,EAClB,MAAmC,EACnC,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB;;YAHtB,uBAAA,EAAA,WAAmC;YACnC,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAM5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEI,qBAAM,IAAI,CAAC,6BAA6B,CACjE,GAAG,EACH,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,CACb,EAAA;;wBAPK,kBAAkB,GAAG,SAO1B;wBAED,IAAI,kBAAkB,KAAK,SAAS,EAAE,CAAC;4BACrC,4EAA4E;4BAC5E,sBAAO;oCACL,QAAQ,EAAE,SAAS;oCACnB,SAAS,EAAE,SAAS;iCACrB,EAAA;wBACH,CAAC;wBAEG,QAAQ,GAAG,IAAA,sCAAmB,EAAC,kBAAkB,CAAC,QAAQ,CAAC,CAAA;wBAE/D,IAAI,QAAQ,KAAK,SAAS,EAAE,CAAC;4BAC3B,oDAAoD;4BACpD,QAAQ,GAAG,KAAK,CAAA;wBAClB,CAAC;wBAED,wEAAwE;wBACxE,sBAAO;gCACL,QAAQ,UAAA;gCACR,SAAS,EAAE,kBAAkB,CAAC,SAAS;6BACxC,EAAA;;;;KACF;IAEe,4DAA6B,GAA7C;4DACE,GAAW,EACX,UAAkB,EAClB,MAAmC,EACnC,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB;;YAHtB,uBAAA,EAAA,WAAmC;YACnC,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAS5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAED,qBAAM,IAAI,CAAC,8BAA8B,CAC7D,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,EACZ,CAAC,GAAG,CAAC,CACN,EAAA;;wBAPK,aAAa,GAAG,SAOrB;wBAED,IAAI,aAAa,KAAK,SAAS,EAAE,CAAC;4BAChC,sBAAO,SAAS,EAAA;wBAClB,CAAC;wBAEK,YAAY,GAAG,aAAa,CAAC,KAAK,CAAA;wBAElC,UAAU,GAAG,YAAY,CAAC,GAAG,CAAC,CAAA;wBAEpC,sBAAO;gCACL,QAAQ,EAAE,UAAU;gCACpB,SAAS,EAAE,aAAa,CAAC,SAAS;6BACnC,EAAA;;;;KACF;IAEe,6DAA8B,GAA9C;4DACE,GAAW,EACX,UAAkB,EAClB,MAAmC,EACnC,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB;;YAHtB,uBAAA,EAAA,WAAmC;YACnC,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAG5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEN,qBAAM,IAAI,CAAC,+BAA+B,CACzD,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,EACZ,CAAC,GAAG,CAAC,CACN,EAAA;;wBAPK,QAAQ,GAAG,SAOhB;wBAED,IAAI,CAAC,QAAQ,EAAE,CAAC;4BACd,sBAAO,SAAS,EAAA;wBAClB,CAAC;wBAEK,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAA;wBAE9B,yGAAyG;wBACzG,IAAI,QAAQ,KAAK,SAAS,EAAE,CAAC;4BAC3B,sBAAO,IAAI,EAAA;wBACb,CAAC;wBAED,sBAAO,QAAQ,EAAA;;;;KAChB;IAEe,8DAA+B,GAA/C;4DACE,UAAkB,EAClB,MAAmC,EACnC,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB,EACtB,kBAA6B;;YAJ7B,uBAAA,EAAA,WAAmC;YACnC,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAI5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAGrB,qBAAM,IAAI,CAAC,mCAAmC,CAC5C,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,EACZ,kBAAkB,CACnB,EAAA;;wBARG,QAAQ,GAAG,CACf,SAOC,CACF,CAAC,QAAQ;wBAEV,sBAAO,QAAQ,EAAA;;;;KAChB;IAEe,uDAAwB,GAAxC;4DACE,UAAkB,EAClB,MAA4C,EAC5C,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB,EACtB,kBAA6B;YAJ7B,uBAAA,EAAA,WAA4C;YAC5C,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAQ5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEhB,qBAAM,IAAI,CAAC,mCAAmC,CACnD,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,EACZ,kBAAkB,CACnB,EAAA;4BAPD,sBAAO,SAON,EAAA;;;;KACF;IAEe,kEAAmC,GAAnD;4DACE,UAAkB,EAClB,MAA4C,EAC5C,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB,EACtB,kBAA6B;;YAJ7B,uBAAA,EAAA,WAA4C;YAC5C,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAQ5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEI,qBAAM,IAAI,CAAC,8BAA8B,CAClE,UAAU,EACV,MAAM,EACN,gBAAgB,EAChB,eAAe,EACf,YAAY,EACZ,kBAAkB,CACnB,EAAA;;wBAPK,kBAAkB,GAAG,SAO1B;wBAED,IAAI,CAAC,kBAAkB,EAAE,CAAC;4BACxB,sBAAO;oCACL,KAAK,EAAE,SAAS;oCAChB,QAAQ,EAAE,SAAS;oCACnB,SAAS,EAAE,SAAS;iCACrB,EAAA;wBACH,CAAC;wBAED,sBAAO;gCACL,KAAK,EAAE,kBAAkB,CAAC,YAAY;gCACtC,QAAQ,EAAE,kBAAkB,CAAC,mBAAmB;gCAChD,SAAS,EAAE,kBAAkB,CAAC,SAAS;6BACxC,EAAA;;;;KACF;IAEe,6DAA8B,GAA9C;4DACE,UAAkB,EAClB,MAA4C,EAC5C,gBAA6C,EAC7C,eAA4D,EAC5D,YAAsB,EACtB,kBAA6B;;;YAJ7B,uBAAA,EAAA,WAA4C;YAC5C,iCAAA,EAAA,qBAA6C;YAC7C,gCAAA,EAAA,oBAA4D;;;4BAI5D,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEjB,YAAY,GAAwB,EAAE,CAAA;wBAC5C,IAAI,YAAY,aAAZ,YAAY,cAAZ,YAAY,GAAI,IAAI,CAAC,YAAY,EAAE,CAAC;4BACtC,YAAY,CAAC,eAAe,CAAC,GAAG,IAAI,CAAA;wBACtC,CAAC;wBACD,IAAI,kBAAkB,EAAE,CAAC;4BACvB,YAAY,CAAC,uBAAuB,CAAC,GAAG,kBAAkB,CAAA;wBAC5D,CAAC;wBACqB,qBAAM,IAAI,CAAC,QAAQ,CAAC,UAAU,EAAE,MAAM,EAAE,gBAAgB,EAAE,eAAe,EAAE,YAAY,CAAC,EAAA;;wBAAxG,aAAa,GAAG,SAAwF;wBAE9G,IAAI,aAAa,KAAK,SAAS,EAAE,CAAC;4BAChC,+CAA+C;4BAC/C,sBAAO,SAAS,EAAA;wBAClB,CAAC;wBAED,0FAA0F;wBAC1F,IAAI,aAAa,CAAC,yBAAyB,EAAE,CAAC;4BAC5C,OAAO,CAAC,KAAK,CACX,kKAAkK,CACnK,CAAA;wBACH,CAAC;wBAED,kDAAkD;wBAClD,IAAI,MAAA,aAAa,CAAC,YAAY,0CAAE,QAAQ,CAAC,mBAAmB,CAAC,YAAY,CAAC,EAAE,CAAC;4BAC3E,OAAO,CAAC,IAAI,CACV,mKAAmK,CACpK,CAAA;4BACD,sBAAO;oCACL,KAAK,EAAE,EAAE;oCACT,YAAY,EAAE,EAAE;oCAChB,mBAAmB,EAAE,EAAE;oCACvB,SAAS,EAAE,aAAa,aAAb,aAAa,uBAAb,aAAa,CAAE,SAAS;iCACpC,EAAA;wBACH,CAAC;wBAED,sBAAO,aAAa,EAAA;;;;KACrB;IAED;;SAEK;IAEQ,kDAAmB,GAAhC;;;;;;4BACE,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEvB,IAAI,IAAI,CAAC,cAAc,KAAK,IAAI,EAAE,CAAC;4BACjC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,8BAA8B,CAAC,CAAA;4BACjD,sBAAO,EAAE,EAAA;wBACX,CAAC;wBAEK,GAAG,GAAG,UAAG,IAAI,CAAC,IAAI,iCAAuB,IAAI,CAAC,MAAM,CAAE,CAAA;wBACtD,YAAY,GAAwB;4BACxC,MAAM,EAAE,KAAK;4BACb,OAAO,wBAAO,IAAI,CAAC,gBAAgB,EAAE,KAAE,cAAc,EAAE,kBAAkB,GAAE;yBAC5E,CAAA;wBAEgB,qBAAM,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,YAAY,CAAC;iCAC1D,IAAI,CAAC,UAAC,QAAQ;gCACb,IAAI,QAAQ,CAAC,MAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;oCAC9C,IAAM,GAAG,GAAG,2CAAoC,QAAQ,CAAC,MAAM,CAAE,CAAA;oCACjE,IAAM,KAAK,GAAG,IAAI,KAAK,CAAC,GAAG,CAAC,CAAA;oCAC5B,KAAI,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;oCAEzB,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,CAAA;oCAC1C,OAAO,SAAS,CAAA;gCAClB,CAAC;gCAED,OAAO,QAAQ,CAAC,IAAI,EAA6B,CAAA;4BACnD,CAAC,CAAC;iCACD,KAAK,CAAC,UAAC,KAAK;gCACX,KAAI,CAAC,OAAO,CAAC,KAAK,CAAC,iCAAiC,EAAE,KAAK,CAAC,CAAA;gCAE5D,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;gCACjC,OAAO,SAAS,CAAA;4BAClB,CAAC,CAAC,EAAA;;wBAlBE,QAAQ,GAAG,SAkBb;wBAEE,UAAU,GAAG,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,OAAO,CAAA;wBAEpC,IAAI,UAAU,EAAE,CAAC;4BACf,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,4BAA4B,EAAE,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,CAAA;wBAC7E,CAAC;wBAED,sBAAO,UAAU,aAAV,UAAU,cAAV,UAAU,GAAI,EAAE,EAAA;;;;KACxB;IAOD,sBAAc,uCAAK;aAAnB;YACE,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;gBACjB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,oBAAoB,CAAyB,gCAAwB,CAAC,KAAK,CAAC,CAAA;YACjG,CAAC;YACD,OAAO,IAAI,CAAC,MAAM,IAAI,EAAE,CAAA;QAC1B,CAAC;aAED,UAAoB,GAAuC;YACzD,IAAI,CAAC,MAAM,GAAG,GAAG,CAAA;QACnB,CAAC;;;OAJA;IAMK,uCAAQ,GAAd,UAAe,UAAkC;;;;gBAC/C,IAAI,CAAC,IAAI,CAAC;oBACR,KAAI,CAAC,KAAK,yBACL,KAAI,CAAC,KAAK,GACV,UAAU,CACd,CAAA;oBACD,KAAI,CAAC,oBAAoB,CAAyB,gCAAwB,CAAC,KAAK,EAAE,KAAI,CAAC,KAAK,CAAC,CAAA;gBAC/F,CAAC,CAAC,CAAA;;;;KACH;IAEK,yCAAU,GAAhB,UAAiB,QAAgB;;;;gBAC/B,IAAI,CAAC,IAAI,CAAC;oBACR,OAAO,KAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;oBAC3B,KAAI,CAAC,oBAAoB,CAAyB,gCAAwB,CAAC,KAAK,EAAE,KAAI,CAAC,KAAK,CAAC,CAAA;gBAC/F,CAAC,CAAC,CAAA;;;;KACH;IAED;;SAEK;IACK,sCAAO,GAAjB,UAAkB,IAAY,EAAE,QAAa,EAAE,OAA+B;QAA9E,iBA8BC;QA7BC,IAAI,CAAC,IAAI,CAAC;YACR,IAAI,KAAI,CAAC,QAAQ,EAAE,CAAC;gBAClB,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,4EAA4E,CAAC,CAAA;gBACrG,OAAM;YACR,CAAC;YAED,IAAM,OAAO,GAAG,KAAI,CAAC,cAAc,CAAC,IAAI,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAA;YAE5D,IAAM,KAAK,GAAG,KAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,CAAC,IAAI,EAAE,CAAA;YAEjG,IAAI,KAAK,CAAC,MAAM,IAAI,KAAI,CAAC,YAAY,EAAE,CAAC;gBACtC,KAAK,CAAC,KAAK,EAAE,CAAA;gBACb,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,6CAA6C,CAAC,CAAA;YAClE,CAAC;YAED,KAAK,CAAC,IAAI,CAAC,EAAE,OAAO,SAAA,EAAE,CAAC,CAAA;YACvB,KAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,EAAE,KAAK,CAAC,CAAA;YAEpF,KAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;YAEhC,oDAAoD;YACpD,IAAI,KAAK,CAAC,MAAM,IAAI,KAAI,CAAC,OAAO,EAAE,CAAC;gBACjC,KAAI,CAAC,eAAe,EAAE,CAAA;YACxB,CAAC;YAED,IAAI,KAAI,CAAC,aAAa,IAAI,CAAC,KAAI,CAAC,WAAW,EAAE,CAAC;gBAC5C,KAAI,CAAC,WAAW,GAAG,IAAA,sBAAc,EAAC,cAAM,OAAA,KAAI,CAAC,eAAe,EAAE,EAAtB,CAAsB,EAAE,KAAI,CAAC,aAAa,CAAC,CAAA;YACrF,CAAC;QACH,CAAC,CAAC,CAAA;IACJ,CAAC;IAEe,4CAAa,GAA7B,UAA8B,IAAY,EAAE,QAAa,EAAE,OAA+B;;;;;;wBACxF,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;4BAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAA;4BAC3C,sBAAM;wBACR,CAAC;6BAEG,CAAC,IAAI,CAAC,cAAc,EAApB,wBAAoB;wBACtB,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;;;wBAGzB,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;4BAClB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,4EAA4E,CAAC,CAAA;4BACrG,sBAAM;wBACR,CAAC;wBAEK,IAAI,GAAwB;4BAChC,OAAO,EAAE,IAAI,CAAC,MAAM;4BACpB,KAAK,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;4BACrD,OAAO,EAAE,IAAA,sBAAc,GAAE;yBAC1B,CAAA;wBAED,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;4BAC7B,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAA;wBAClC,CAAC;wBAEK,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAA;wBAE9B,GAAG,GAAG,UAAG,IAAI,CAAC,IAAI,YAAS,CAAA;6BAEV,CAAC,IAAI,CAAC,kBAAkB,EAAxB,wBAAwB;wBAAG,qBAAM,IAAA,mBAAY,EAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,EAAA;;wBAAzC,KAAA,SAAyC,CAAA;;;wBAAG,KAAA,IAAI,CAAA;;;wBAA5F,cAAc,KAA8E;wBAC5F,YAAY,GAAwB;4BACxC,MAAM,EAAE,MAAM;4BACd,OAAO,iCACF,IAAI,CAAC,gBAAgB,EAAE,KAC1B,cAAc,EAAE,kBAAkB,KAC/B,CAAC,cAAc,KAAK,IAAI,IAAI,EAAE,kBAAkB,EAAE,MAAM,EAAE,CAAC,CAC/D;4BACD,IAAI,EAAE,cAAc,IAAI,OAAO;yBAChC,CAAA;;;;wBAGC,qBAAM,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,YAAY,CAAC,EAAA;;wBAA5C,SAA4C,CAAA;;;;wBAE5C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAG,CAAC,CAAA;;;;;;KAElC;IAEO,6CAAc,GAAtB,UAAuB,IAAY,EAAE,QAAa,EAAE,OAA+B;;QACjF,IAAM,OAAO,yBACR,QAAQ,KACX,IAAI,EAAE,IAAI,EACV,OAAO,EAAE,IAAI,CAAC,YAAY,EAAE,EAC5B,eAAe,EAAE,IAAI,CAAC,iBAAiB,EAAE,EACzC,SAAS,EAAE,CAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,SAAS,EAAC,CAAC,CAAC,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,SAAS,CAAC,CAAC,CAAC,IAAA,sBAAc,GAAE,EACrE,IAAI,EAAE,CAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,IAAI,EAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,IAAA,eAAM,GAAE,GAC9C,CAAA;QAED,IAAM,uBAAuB,GAAG,MAAA,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,YAAY,mCAAI,IAAI,CAAC,YAAY,CAAA;QAC1E,IAAI,uBAAuB,EAAE,CAAC;YAC5B,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,CAAC;gBACxB,OAAO,CAAC,UAAU,GAAG,EAAE,CAAA;YACzB,CAAC;YACD,OAAO,CAAC,YAAY,CAAC,CAAC,gBAAgB,CAAC,GAAG,IAAI,CAAA;QAChD,CAAC;QAED,IAAI,OAAO,CAAC,UAAU,EAAE,CAAC;YACvB,OAAO,CAAC,WAAW,GAAG,OAAO,CAAC,UAAU,CAAA;YACxC,OAAO,OAAO,CAAC,UAAU,CAAA;QAC3B,CAAC;QAED,OAAO,OAAO,CAAA;IAChB,CAAC;IAEO,8CAAe,GAAvB;QACE,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,YAAY,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;YAC9B,IAAI,CAAC,WAAW,GAAG,SAAS,CAAA;QAC9B,CAAC;IACH,CAAC;IAED;;;OAGG;IACK,8CAAe,GAAvB;QAAA,iBAIC;QAHC,KAAK,IAAI,CAAC,KAAK,EAAE,CAAC,KAAK,CAAC,UAAO,GAAG;;;4BAChC,qBAAM,aAAa,CAAC,GAAG,CAAC,EAAA;;wBAAxB,SAAwB,CAAA;;;;aACzB,CAAC,CAAA;IACJ,CAAC;IAED;;;;;;;;;;;;;;;;;;;;;;;;;;;OA2BG;IACG,oCAAK,GAAX;;;;;gBAIQ,gBAAgB,GAAG,IAAA,kBAAU,EAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAAC;oBAC5D,OAAO,KAAI,CAAC,MAAM,EAAE,CAAA;gBACtB,CAAC,CAAC,CAAA;gBAEF,IAAI,CAAC,YAAY,GAAG,gBAAgB,CAAA;gBACpC,KAAK,IAAI,CAAC,iBAAiB,CAAC,gBAAgB,CAAC,CAAA;gBAE7C,IAAA,kBAAU,EAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,IAAI,CAAC;oBAClC,8DAA8D;oBAC9D,wEAAwE;oBACxE,IAAI,KAAI,CAAC,YAAY,KAAK,gBAAgB,EAAE,CAAC;wBAC3C,KAAI,CAAC,YAAY,GAAG,IAAI,CAAA;oBAC1B,CAAC;gBACH,CAAC,CAAC,CAAA;gBAEF,sBAAO,gBAAgB,EAAA;;;KACxB;IAES,+CAAgB,GAA1B;QACE,6EAA6E;QAC7E,gFAAgF;QAChF,yFAAyF;QACzF,6DAA6D;QAC7D,IAAM,eAAe,GAAG,IAAI,CAAC,kBAAkB,EAAE,CAAA;QACjD,IAAM,OAAO,GAA8B,EAAE,CAAA;QAC7C,IAAI,eAAe,IAAI,eAAe,KAAK,EAAE,EAAE,CAAC;YAC9C,OAAO,CAAC,YAAY,CAAC,GAAG,eAAe,CAAA;QACzC,CAAC;QACD,OAAO,OAAO,CAAA;IAChB,CAAC;IAEa,qCAAM,GAApB;;;;;;;wBACE,IAAI,CAAC,eAAe,EAAE,CAAA;wBACtB,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAAvB,SAAuB,CAAA;wBAEnB,KAAK,GAAG,IAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,CAAC,IAAI,EAAE,CAAA;wBAE/F,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;4BAClB,sBAAM;wBACR,CAAC;wBAEK,YAAY,GAAU,EAAE,CAAA;wBACxB,mBAAmB,GAAG,KAAK,CAAC,MAAM,CAAA;;;;;;wCAGhC,UAAU,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE,OAAK,YAAY,CAAC,CAAA;wCAC9C,aAAa,GAAG,UAAU,CAAC,GAAG,CAAC,UAAC,IAAI,IAAK,OAAA,IAAI,CAAC,OAAO,EAAZ,CAAY,CAAC,CAAA;wCAEtD,kBAAkB,GAAG;4CACzB,IAAM,cAAc,GAAG,KAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,CAAC,IAAI,EAAE,CAAA;4CAC1G,IAAM,QAAQ,GAAG,cAAc,CAAC,KAAK,CAAC,UAAU,CAAC,MAAM,CAAC,CAAA;4CACxD,KAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAA;4CACvF,KAAK,GAAG,QAAQ,CAAA;wCAClB,CAAC,CAAA;wCAEK,IAAI,GAAwB;4CAChC,OAAO,EAAE,OAAK,MAAM;4CACpB,KAAK,EAAE,aAAa;4CACpB,OAAO,EAAE,IAAA,sBAAc,GAAE;yCAC1B,CAAA;wCAED,IAAI,OAAK,mBAAmB,EAAE,CAAC;4CAC7B,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAA;wCAClC,CAAC;wCAEK,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAA;wCAE9B,GAAG,GAAG,UAAG,OAAK,IAAI,YAAS,CAAA;6CAEV,CAAC,OAAK,kBAAkB,EAAxB,wBAAwB;wCAAG,qBAAM,IAAA,mBAAY,EAAC,OAAO,EAAE,OAAK,OAAO,CAAC,EAAA;;wCAAzC,KAAA,SAAyC,CAAA;;;wCAAG,KAAA,IAAI,CAAA;;;wCAA5F,cAAc,KAA8E;wCAC5F,YAAY,GAAwB;4CACxC,MAAM,EAAE,MAAM;4CACd,OAAO,iCACF,OAAK,gBAAgB,EAAE,KAC1B,cAAc,EAAE,kBAAkB,KAC/B,CAAC,cAAc,KAAK,IAAI,IAAI,EAAE,kBAAkB,EAAE,MAAM,EAAE,CAAC,CAC/D;4CACD,IAAI,EAAE,cAAc,IAAI,OAAO;yCAChC,CAAA;wCAEK,YAAY,GAA8B;4CAC9C,UAAU,EAAE,UAAC,GAAG;gDACd,kFAAkF;gDAClF,IAAI,kCAAkC,CAAC,GAAG,CAAC,EAAE,CAAC;oDAC5C,OAAO,KAAK,CAAA;gDACd,CAAC;gDACD,qCAAqC;gDACrC,OAAO,mBAAmB,CAAC,GAAG,CAAC,CAAA;4CACjC,CAAC;yCACF,CAAA;;;;wCAGC,qBAAM,OAAK,cAAc,CAAC,GAAG,EAAE,YAAY,EAAE,YAAY,CAAC,EAAA;;wCAA1D,SAA0D,CAAA;;;;wCAE1D,IAAI,kCAAkC,CAAC,KAAG,CAAC,IAAI,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;4CACxE,wEAAwE;4CACxE,OAAK,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAA;4CACrE,OAAK,OAAO,CAAC,IAAI,CACf,kDAA2C,aAAa,CAAC,MAAM,sCAA4B,OAAK,YAAY,CAAE,CAC/G,CAAA;;wCAGH,CAAC;wCAED,iGAAiG;wCACjG,gIAAgI;wCAChI,IAAI,CAAC,CAAC,KAAG,YAAY,wBAAwB,CAAC,EAAE,CAAC;4CAC/C,kBAAkB,EAAE,CAAA;wCACtB,CAAC;wCACD,OAAK,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAG,CAAC,CAAA;wCAE/B,MAAM,KAAG,CAAA;;wCAGX,kBAAkB,EAAE,CAAA;wCAEpB,YAAY,CAAC,IAAI,OAAjB,YAAY,2BAAS,aAAa,WAAC;;;;;;;;6BAxE9B,CAAA,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,YAAY,CAAC,MAAM,GAAG,mBAAmB,CAAA;;;;;;wBA0EpE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,YAAY,CAAC,CAAA;;;;;KACzC;IAEa,6CAAc,GAA5B,UACE,GAAW,EACX,OAA4B,EAC5B,YAAwC,EACxC,cAAuB;;;;;;;;;wBAEvB,CAAC;wBAAA,YAAC,WAAmB,EAAC,OAAO,uCAAP,OAAO,GAAK,SAAS,OAAO,CAAC,EAAU;4BAC3D,IAAM,IAAI,GAAG,IAAI,eAAe,EAAE,CAAA;4BAClC,UAAU,CAAC,cAAM,OAAA,IAAI,CAAC,KAAK,EAAE,EAAZ,CAAY,EAAE,EAAE,CAAC,CAAA;4BAClC,OAAO,IAAI,CAAC,MAAM,CAAA;wBACpB,CAAC,EAAA;wBAEK,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAA;wBACzC,aAAa,GAAG,CAAC,CAAC,CAAA;wBACtB,IAAI,CAAC;4BACH,IAAI,IAAI,YAAY,IAAI,EAAE,CAAC;gCACzB,aAAa,GAAG,IAAI,CAAC,IAAI,CAAA;4BAC3B,CAAC;iCAAM,CAAC;gCACN,aAAa,GAAG,MAAM,CAAC,UAAU,CAAC,IAAI,EAAE,qBAAa,CAAC,CAAA;4BACxD,CAAC;wBACH,CAAC;wBAAC,WAAM,CAAC;4BACP,IAAI,IAAI,YAAY,IAAI,EAAE,CAAC;gCACzB,aAAa,GAAG,IAAI,CAAC,IAAI,CAAA;4BAC3B,CAAC;iCAAM,CAAC;gCACA,OAAO,GAAG,IAAI,WAAW,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;gCAC9C,aAAa,GAAG,OAAO,CAAC,MAAM,CAAA;4BAChC,CAAC;wBACH,CAAC;wBAEM,qBAAM,IAAA,iBAAS,EACpB;;;;;4CACM,GAAG,GAAgC,IAAI,CAAA;;;;4CAEnC,qBAAM,IAAI,CAAC,KAAK,CAAC,GAAG,aACxB,MAAM,EAAG,WAAmB,CAAC,OAAO,CAAC,cAAc,aAAd,cAAc,cAAd,cAAc,GAAI,IAAI,CAAC,cAAc,CAAC,IACxE,OAAO,EACV,EAAA;;4CAHF,GAAG,GAAG,SAGJ,CAAA;;;;4CAEF,yDAAyD;4CACzD,MAAM,IAAI,wBAAwB,CAAC,GAAC,CAAC,CAAA;;4CAKjC,QAAQ,GAAG,OAAO,CAAC,IAAI,KAAK,SAAS,CAAA;4CAC3C,IAAI,CAAC,QAAQ,IAAI,CAAC,GAAG,CAAC,MAAM,GAAG,GAAG,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,EAAE,CAAC;gDACzD,MAAM,IAAI,qBAAqB,CAAC,GAAG,EAAE,aAAa,CAAC,CAAA;4CACrD,CAAC;4CACD,sBAAO,GAAG,EAAA;;;iCACX,wBACI,IAAI,CAAC,aAAa,GAAK,YAAY,EACzC,EAAA;4BAtBD,sBAAO,SAsBN,EAAA;;;;KACF;IAEK,wCAAS,GAAf;4DAAgB,iBAAiC;;;YAAjC,kCAAA,EAAA,yBAAiC;;;;oBAC/C,wGAAwG;oBACxG,uFAAuF;oBAEvF,qBAAM,IAAI,CAAC,YAAY,EAAA;;wBAHvB,wGAAwG;wBACxG,uFAAuF;wBAEvF,SAAuB,CAAA;wBACnB,WAAW,GAAG,KAAK,CAAA;wBACvB,IAAI,CAAC,eAAe,EAAE,CAAA;wBAEhB,UAAU,GAAG;;;;;;wCAEf,qBAAM,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,EAAA;;wCAA9B,SAA8B,CAAA;;;6CAEvB,IAAI;wCACH,KAAK,GAAG,IAAI,CAAC,oBAAoB,CAAqB,gCAAwB,CAAC,KAAK,CAAC,IAAI,EAAE,CAAA;wCAEjG,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;4CACvB,wBAAK;wCACP,CAAC;wCAED,iFAAiF;wCACjF,4DAA4D;wCAC5D,iFAAiF;wCACjF,qBAAM,IAAI,CAAC,KAAK,EAAE,EAAA;;wCAHlB,iFAAiF;wCACjF,4DAA4D;wCAC5D,iFAAiF;wCACjF,SAAkB,CAAA;wCAElB,IAAI,WAAW,EAAE,CAAC;4CAChB,wBAAK;wCACP,CAAC;;;;;wCAGH,IAAI,CAAC,mBAAmB,CAAC,GAAC,CAAC,EAAE,CAAC;4CAC5B,MAAM,GAAC,CAAA;wCACT,CAAC;wCAED,qBAAM,aAAa,CAAC,GAAC,CAAC,EAAA;;wCAAtB,SAAsB,CAAA;;;;;6BAEzB,CAAA;wBAED,sBAAO,OAAO,CAAC,IAAI,CAAC;gCAClB,IAAI,OAAO,CAAO,UAAC,CAAC,EAAE,MAAM;oCAC1B,IAAA,sBAAc,EAAC;wCACb,KAAI,CAAC,OAAO,CAAC,KAAK,CAAC,uCAAuC,CAAC,CAAA;wCAC3D,WAAW,GAAG,IAAI,CAAA;wCAClB,MAAM,CAAC,0EAA0E,CAAC,CAAA;oCACpF,CAAC,EAAE,iBAAiB,CAAC,CAAA;gCACvB,CAAC,CAAC;gCACF,UAAU,EAAE;6BACb,CAAC,EAAA;;;;KACH;IAED;;;;;;;;;;;;;;;;;;;;;;OAsBG;IACG,uCAAQ,GAAd;4DAAe,iBAAiC;;YAAjC,kCAAA,EAAA,yBAAiC;;gBAC9C,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;oBACzB,IAAI,CAAC,OAAO,CAAC,IAAI,CACf,gJAAgJ,CACjJ,CAAA;gBACH,CAAC;qBAAM,CAAC;oBACN,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,CAAC,OAAO,CAAC;wBAC/D,KAAI,CAAC,eAAe,GAAG,IAAI,CAAA;oBAC7B,CAAC,CAAC,CAAA;gBACJ,CAAC;gBACD,sBAAO,IAAI,CAAC,eAAe,EAAA;;;KAC5B;IACH,2BAAC;AAAD,CAAC,AAhnCD,IAgnCC;AAhnCqB,oDAAoB","sourcesContent":["import { SimpleEventEmitter } from './eventemitter'\nimport { getFeatureFlagValue, normalizeFlagsResponse } from './featureFlagUtils'\nimport { gzipCompress, isGzipSupported } from './gzip'\nimport { createLogger } from './logger'\nimport {\n  PostHogFlagsResponse,\n  PostHogCoreOptions,\n  PostHogEventProperties,\n  PostHogCaptureOptions,\n  JsonType,\n  PostHogRemoteConfig,\n  FeatureFlagValue,\n  PostHogV2FlagsResponse,\n  PostHogV1FlagsResponse,\n  PostHogFeatureFlagDetails,\n  FeatureFlagDetail,\n  SurveyResponse,\n  PostHogFetchResponse,\n  PostHogFetchOptions,\n  PostHogPersistedProperty,\n  PostHogQueueItem,\n  Logger,\n} from './types'\nimport {\n  allSettled,\n  assert,\n  currentISOTime,\n  PromiseQueue,\n  removeTrailingSlash,\n  retriable,\n  RetriableOptions,\n  safeSetTimeout,\n  STRING_FORMAT,\n} from './utils'\nimport { uuidv7 } from './vendor/uuidv7'\n\nclass PostHogFetchHttpError extends Error {\n  name = 'PostHogFetchHttpError'\n\n  constructor(\n    public response: PostHogFetchResponse,\n    public reqByteLength: number\n  ) {\n    super('HTTP error while fetching PostHog: status=' + response.status + ', reqByteLength=' + reqByteLength)\n  }\n\n  get status(): number {\n    return this.response.status\n  }\n\n  get text(): Promise<string> {\n    return this.response.text()\n  }\n\n  get json(): Promise<any> {\n    return this.response.json()\n  }\n}\n\nclass PostHogFetchNetworkError extends Error {\n  name = 'PostHogFetchNetworkError'\n\n  constructor(public error: unknown) {\n    // TRICKY: \"cause\" is a newer property but is just ignored otherwise. Cast to any to ignore the type issue.\n    // eslint-disable-next-line @typescript-eslint/prefer-ts-expect-error\n    // @ts-ignore\n    super('Network error while fetching PostHog', error instanceof Error ? { cause: error } : {})\n  }\n}\n\nexport const maybeAdd = (key: string, value: JsonType | undefined): Record<string, JsonType> =>\n  value !== undefined ? { [key]: value } : {}\n\nexport async function logFlushError(err: any): Promise<void> {\n  if (err instanceof PostHogFetchHttpError) {\n    let text = ''\n    try {\n      text = await err.text\n    } catch {}\n\n    console.error(`Error while flushing PostHog: message=${err.message}, response body=${text}`, err)\n  } else {\n    console.error('Error while flushing PostHog', err)\n  }\n  return Promise.resolve()\n}\n\nfunction isPostHogFetchError(err: unknown): err is PostHogFetchHttpError | PostHogFetchNetworkError {\n  return typeof err === 'object' && (err instanceof PostHogFetchHttpError || err instanceof PostHogFetchNetworkError)\n}\n\nfunction isPostHogFetchContentTooLargeError(err: unknown): err is PostHogFetchHttpError & { status: 413 } {\n  return typeof err === 'object' && err instanceof PostHogFetchHttpError && err.status === 413\n}\n\nexport enum QuotaLimitedFeature {\n  FeatureFlags = 'feature_flags',\n  Recordings = 'recordings',\n}\n\nexport abstract class PostHogCoreStateless {\n  // options\n  readonly apiKey: string\n  readonly host: string\n  readonly flushAt: number\n  readonly preloadFeatureFlags: boolean\n  readonly disableSurveys: boolean\n  private maxBatchSize: number\n  private maxQueueSize: number\n  private flushInterval: number\n  private flushPromise: Promise<any> | null = null\n  private shutdownPromise: Promise<void> | null = null\n  private requestTimeout: number\n  private featureFlagsRequestTimeoutMs: number\n  private remoteConfigRequestTimeoutMs: number\n  private removeDebugCallback?: () => void\n  private disableGeoip: boolean\n  private historicalMigration: boolean\n  private evaluationEnvironments?: readonly string[]\n  protected disabled\n  protected disableCompression: boolean\n\n  private defaultOptIn: boolean\n  private promiseQueue: PromiseQueue = new PromiseQueue()\n\n  // internal\n  protected _events = new SimpleEventEmitter()\n  protected _flushTimer?: any\n  protected _retryOptions: RetriableOptions\n  protected _initPromise: Promise<void>\n  protected _isInitialized: boolean = false\n  protected _remoteConfigResponsePromise?: Promise<PostHogRemoteConfig | undefined>\n  protected _logger: Logger\n\n  // Abstract methods to be overridden by implementations\n  abstract fetch(url: string, options: PostHogFetchOptions): Promise<PostHogFetchResponse>\n  abstract getLibraryId(): string\n  abstract getLibraryVersion(): string\n  abstract getCustomUserAgent(): string | void\n\n  // This is our abstracted storage. Each implementation should handle its own\n  abstract getPersistedProperty<T>(key: PostHogPersistedProperty): T | undefined\n  abstract setPersistedProperty<T>(key: PostHogPersistedProperty, value: T | null): void\n\n  constructor(apiKey: string, options: PostHogCoreOptions = {}) {\n    assert(apiKey, \"You must pass your PostHog project's api key.\")\n\n    this.apiKey = apiKey\n    this.host = removeTrailingSlash(options.host || 'https://us.i.posthog.com')\n    this.flushAt = options.flushAt ? Math.max(options.flushAt, 1) : 20\n    this.maxBatchSize = Math.max(this.flushAt, options.maxBatchSize ?? 100)\n    this.maxQueueSize = Math.max(this.flushAt, options.maxQueueSize ?? 1000)\n    this.flushInterval = options.flushInterval ?? 10000\n    this.preloadFeatureFlags = options.preloadFeatureFlags ?? true\n    // If enable is explicitly set to false we override the optout\n    this.defaultOptIn = options.defaultOptIn ?? true\n    this.disableSurveys = options.disableSurveys ?? false\n\n    this._retryOptions = {\n      retryCount: options.fetchRetryCount ?? 3,\n      retryDelay: options.fetchRetryDelay ?? 3000, // 3 seconds\n      retryCheck: isPostHogFetchError,\n    }\n    this.requestTimeout = options.requestTimeout ?? 10000 // 10 seconds\n    this.featureFlagsRequestTimeoutMs = options.featureFlagsRequestTimeoutMs ?? 3000 // 3 seconds\n    this.remoteConfigRequestTimeoutMs = options.remoteConfigRequestTimeoutMs ?? 3000 // 3 seconds\n    this.disableGeoip = options.disableGeoip ?? true\n    this.disabled = options.disabled ?? false\n    this.historicalMigration = options?.historicalMigration ?? false\n    this.evaluationEnvironments = options?.evaluationEnvironments\n    // Init promise allows the derived class to block calls until it is ready\n    this._initPromise = Promise.resolve()\n    this._isInitialized = true\n    this._logger = createLogger('[PostHog]', this.logMsgIfDebug.bind(this))\n    this.disableCompression = !isGzipSupported() || (options?.disableCompression ?? false)\n  }\n\n  protected logMsgIfDebug(fn: () => void): void {\n    if (this.isDebug) {\n      fn()\n    }\n  }\n\n  protected wrap(fn: () => void): void {\n    if (this.disabled) {\n      this._logger.warn('The client is disabled')\n      return\n    }\n\n    if (this._isInitialized) {\n      // NOTE: We could also check for the \"opt in\" status here...\n      return fn()\n    }\n\n    this._initPromise.then(() => fn())\n  }\n\n  protected getCommonEventProperties(): PostHogEventProperties {\n    return {\n      $lib: this.getLibraryId(),\n      $lib_version: this.getLibraryVersion(),\n    }\n  }\n\n  public get optedOut(): boolean {\n    return this.getPersistedProperty(PostHogPersistedProperty.OptedOut) ?? !this.defaultOptIn\n  }\n\n  async optIn(): Promise<void> {\n    this.wrap(() => {\n      this.setPersistedProperty(PostHogPersistedProperty.OptedOut, false)\n    })\n  }\n\n  async optOut(): Promise<void> {\n    this.wrap(() => {\n      this.setPersistedProperty(PostHogPersistedProperty.OptedOut, true)\n    })\n  }\n\n  on(event: string, cb: (...args: any[]) => void): () => void {\n    return this._events.on(event, cb)\n  }\n\n  /**\n   * Enables or disables debug mode for detailed logging.\n   *\n   * @remarks\n   * Debug mode logs all PostHog calls to the console for troubleshooting.\n   * This is useful during development to understand what data is being sent.\n   *\n   * {@label Initialization}\n   *\n   * @example\n   * ```js\n   * // enable debug mode\n   * posthog.debug(true)\n   * ```\n   *\n   * @example\n   * ```js\n   * // disable debug mode\n   * posthog.debug(false)\n   * ```\n   *\n   * @public\n   *\n   * @param {boolean} [debug] If true, will enable debug mode.\n   */\n  debug(enabled: boolean = true): void {\n    this.removeDebugCallback?.()\n\n    if (enabled) {\n      const removeDebugCallback = this.on('*', (event, payload) => this._logger.info(event, payload))\n      this.removeDebugCallback = () => {\n        removeDebugCallback()\n        this.removeDebugCallback = undefined\n      }\n    }\n  }\n\n  get isDebug(): boolean {\n    return !!this.removeDebugCallback\n  }\n\n  get isDisabled(): boolean {\n    return this.disabled\n  }\n\n  private buildPayload(payload: {\n    distinct_id: string\n    event: string\n    properties?: PostHogEventProperties\n  }): PostHogEventProperties {\n    return {\n      distinct_id: payload.distinct_id,\n      event: payload.event,\n      properties: {\n        ...(payload.properties || {}),\n        ...this.getCommonEventProperties(), // Common PH props\n      },\n    }\n  }\n\n  public addPendingPromise<T>(promise: Promise<T>): Promise<T> {\n    return this.promiseQueue.add(promise)\n  }\n\n  /***\n   *** TRACKING\n   ***/\n  protected identifyStateless(\n    distinctId: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      // The properties passed to identifyStateless are event properties.\n      // To add person properties, pass in all person properties to the `$set` and `$set_once` keys.\n\n      const payload = {\n        ...this.buildPayload({\n          distinct_id: distinctId,\n          event: '$identify',\n          properties,\n        }),\n      }\n\n      this.enqueue('identify', payload, options)\n    })\n  }\n\n  protected async identifyStatelessImmediate(\n    distinctId: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): Promise<void> {\n    const payload = {\n      ...this.buildPayload({\n        distinct_id: distinctId,\n        event: '$identify',\n        properties,\n      }),\n    }\n\n    await this.sendImmediate('identify', payload, options)\n  }\n\n  protected captureStateless(\n    distinctId: string,\n    event: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      const payload = this.buildPayload({ distinct_id: distinctId, event, properties })\n      this.enqueue('capture', payload, options)\n    })\n  }\n\n  protected async captureStatelessImmediate(\n    distinctId: string,\n    event: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): Promise<void> {\n    const payload = this.buildPayload({ distinct_id: distinctId, event, properties })\n    await this.sendImmediate('capture', payload, options)\n  }\n\n  protected aliasStateless(\n    alias: string,\n    distinctId: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): void {\n    this.wrap(() => {\n      const payload = this.buildPayload({\n        event: '$create_alias',\n        distinct_id: distinctId,\n        properties: {\n          ...(properties || {}),\n          distinct_id: distinctId,\n          alias,\n        },\n      })\n\n      this.enqueue('alias', payload, options)\n    })\n  }\n\n  protected async aliasStatelessImmediate(\n    alias: string,\n    distinctId: string,\n    properties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions\n  ): Promise<void> {\n    const payload = this.buildPayload({\n      event: '$create_alias',\n      distinct_id: distinctId,\n      properties: {\n        ...(properties || {}),\n        distinct_id: distinctId,\n        alias,\n      },\n    })\n\n    await this.sendImmediate('alias', payload, options)\n  }\n\n  /***\n   *** GROUPS\n   ***/\n  protected groupIdentifyStateless(\n    groupType: string,\n    groupKey: string | number,\n    groupProperties?: PostHogEventProperties,\n    options?: PostHogCaptureOptions,\n    distinctId?: string,\n    eventProperties?: PostHogEventProperties\n  ): void {\n    this.wrap(() => {\n      const payload = this.buildPayload({\n        distinct_id: distinctId || `$${groupType}_${groupKey}`,\n        event: '$groupidentify',\n        properties: {\n          $group_type: groupType,\n          $group_key: groupKey,\n          $group_set: groupProperties || {},\n          ...(eventProperties || {}),\n        },\n      })\n\n      this.enqueue('capture', payload, options)\n    })\n  }\n\n  protected async getRemoteConfig(): Promise<PostHogRemoteConfig | undefined> {\n    await this._initPromise\n\n    let host = this.host\n\n    if (host === 'https://us.i.posthog.com') {\n      host = 'https://us-assets.i.posthog.com'\n    } else if (host === 'https://eu.i.posthog.com') {\n      host = 'https://eu-assets.i.posthog.com'\n    }\n\n    const url = `${host}/array/${this.apiKey}/config`\n    const fetchOptions: PostHogFetchOptions = {\n      method: 'GET',\n      headers: { ...this.getCustomHeaders(), 'Content-Type': 'application/json' },\n    }\n    // Don't retry remote config API calls\n    return this.fetchWithRetry(url, fetchOptions, { retryCount: 0 }, this.remoteConfigRequestTimeoutMs)\n      .then((response) => response.json() as Promise<PostHogRemoteConfig>)\n      .catch((error) => {\n        this._logger.error('Remote config could not be loaded', error)\n        this._events.emit('error', error)\n        return undefined\n      })\n  }\n\n  /***\n   *** FEATURE FLAGS\n   ***/\n\n  protected async getFlags(\n    distinctId: string,\n    groups: Record<string, string | number> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    extraPayload: Record<string, any> = {},\n    fetchConfig: boolean = true\n  ): Promise<PostHogFlagsResponse | undefined> {\n    await this._initPromise\n\n    const configParam = fetchConfig ? '&config=true' : ''\n    const url = `${this.host}/flags/?v=2${configParam}`\n    const requestData: Record<string, any> = {\n      token: this.apiKey,\n      distinct_id: distinctId,\n      groups,\n      person_properties: personProperties,\n      group_properties: groupProperties,\n      ...extraPayload,\n    }\n\n    // Add evaluation environments if configured\n    if (this.evaluationEnvironments && this.evaluationEnvironments.length > 0) {\n      requestData.evaluation_environments = this.evaluationEnvironments\n    }\n\n    const fetchOptions: PostHogFetchOptions = {\n      method: 'POST',\n      headers: { ...this.getCustomHeaders(), 'Content-Type': 'application/json' },\n      body: JSON.stringify(requestData),\n    }\n\n    this._logger.info('Flags URL', url)\n\n    // Don't retry /flags API calls\n    return this.fetchWithRetry(url, fetchOptions, { retryCount: 0 }, this.featureFlagsRequestTimeoutMs)\n      .then((response) => response.json() as Promise<PostHogV1FlagsResponse | PostHogV2FlagsResponse>)\n      .then((response) => normalizeFlagsResponse(response))\n      .catch((error) => {\n        this._events.emit('error', error)\n        return undefined\n      }) as Promise<PostHogFlagsResponse | undefined>\n  }\n\n  protected async getFeatureFlagStateless(\n    key: string,\n    distinctId: string,\n    groups: Record<string, string> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean\n  ): Promise<{\n    response: FeatureFlagValue | undefined\n    requestId: string | undefined\n  }> {\n    await this._initPromise\n\n    const flagDetailResponse = await this.getFeatureFlagDetailStateless(\n      key,\n      distinctId,\n      groups,\n      personProperties,\n      groupProperties,\n      disableGeoip\n    )\n\n    if (flagDetailResponse === undefined) {\n      // If we haven't loaded flags yet, or errored out, we respond with undefined\n      return {\n        response: undefined,\n        requestId: undefined,\n      }\n    }\n\n    let response = getFeatureFlagValue(flagDetailResponse.response)\n\n    if (response === undefined) {\n      // For cases where the flag is unknown, return false\n      response = false\n    }\n\n    // If we have flags we either return the value (true or string) or false\n    return {\n      response,\n      requestId: flagDetailResponse.requestId,\n    }\n  }\n\n  protected async getFeatureFlagDetailStateless(\n    key: string,\n    distinctId: string,\n    groups: Record<string, string> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean\n  ): Promise<\n    | {\n        response: FeatureFlagDetail | undefined\n        requestId: string | undefined\n      }\n    | undefined\n  > {\n    await this._initPromise\n\n    const flagsResponse = await this.getFeatureFlagDetailsStateless(\n      distinctId,\n      groups,\n      personProperties,\n      groupProperties,\n      disableGeoip,\n      [key]\n    )\n\n    if (flagsResponse === undefined) {\n      return undefined\n    }\n\n    const featureFlags = flagsResponse.flags\n\n    const flagDetail = featureFlags[key]\n\n    return {\n      response: flagDetail,\n      requestId: flagsResponse.requestId,\n    }\n  }\n\n  protected async getFeatureFlagPayloadStateless(\n    key: string,\n    distinctId: string,\n    groups: Record<string, string> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean\n  ): Promise<JsonType | undefined> {\n    await this._initPromise\n\n    const payloads = await this.getFeatureFlagPayloadsStateless(\n      distinctId,\n      groups,\n      personProperties,\n      groupProperties,\n      disableGeoip,\n      [key]\n    )\n\n    if (!payloads) {\n      return undefined\n    }\n\n    const response = payloads[key]\n\n    // Undefined means a loading or missing data issue. Null means evaluation happened and there was no match\n    if (response === undefined) {\n      return null\n    }\n\n    return response\n  }\n\n  protected async getFeatureFlagPayloadsStateless(\n    distinctId: string,\n    groups: Record<string, string> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean,\n    flagKeysToEvaluate?: string[]\n  ): Promise<PostHogFlagsResponse['featureFlagPayloads'] | undefined> {\n    await this._initPromise\n\n    const payloads = (\n      await this.getFeatureFlagsAndPayloadsStateless(\n        distinctId,\n        groups,\n        personProperties,\n        groupProperties,\n        disableGeoip,\n        flagKeysToEvaluate\n      )\n    ).payloads\n\n    return payloads\n  }\n\n  protected async getFeatureFlagsStateless(\n    distinctId: string,\n    groups: Record<string, string | number> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean,\n    flagKeysToEvaluate?: string[]\n  ): Promise<{\n    flags: PostHogFlagsResponse['featureFlags'] | undefined\n    payloads: PostHogFlagsResponse['featureFlagPayloads'] | undefined\n    requestId: PostHogFlagsResponse['requestId'] | undefined\n  }> {\n    await this._initPromise\n\n    return await this.getFeatureFlagsAndPayloadsStateless(\n      distinctId,\n      groups,\n      personProperties,\n      groupProperties,\n      disableGeoip,\n      flagKeysToEvaluate\n    )\n  }\n\n  protected async getFeatureFlagsAndPayloadsStateless(\n    distinctId: string,\n    groups: Record<string, string | number> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean,\n    flagKeysToEvaluate?: string[]\n  ): Promise<{\n    flags: PostHogFlagsResponse['featureFlags'] | undefined\n    payloads: PostHogFlagsResponse['featureFlagPayloads'] | undefined\n    requestId: PostHogFlagsResponse['requestId'] | undefined\n  }> {\n    await this._initPromise\n\n    const featureFlagDetails = await this.getFeatureFlagDetailsStateless(\n      distinctId,\n      groups,\n      personProperties,\n      groupProperties,\n      disableGeoip,\n      flagKeysToEvaluate\n    )\n\n    if (!featureFlagDetails) {\n      return {\n        flags: undefined,\n        payloads: undefined,\n        requestId: undefined,\n      }\n    }\n\n    return {\n      flags: featureFlagDetails.featureFlags,\n      payloads: featureFlagDetails.featureFlagPayloads,\n      requestId: featureFlagDetails.requestId,\n    }\n  }\n\n  protected async getFeatureFlagDetailsStateless(\n    distinctId: string,\n    groups: Record<string, string | number> = {},\n    personProperties: Record<string, string> = {},\n    groupProperties: Record<string, Record<string, string>> = {},\n    disableGeoip?: boolean,\n    flagKeysToEvaluate?: string[]\n  ): Promise<PostHogFeatureFlagDetails | undefined> {\n    await this._initPromise\n\n    const extraPayload: Record<string, any> = {}\n    if (disableGeoip ?? this.disableGeoip) {\n      extraPayload['geoip_disable'] = true\n    }\n    if (flagKeysToEvaluate) {\n      extraPayload['flag_keys_to_evaluate'] = flagKeysToEvaluate\n    }\n    const flagsResponse = await this.getFlags(distinctId, groups, personProperties, groupProperties, extraPayload)\n\n    if (flagsResponse === undefined) {\n      // We probably errored out, so return undefined\n      return undefined\n    }\n\n    // if there's an error on the flagsResponse, log a console error, but don't throw an error\n    if (flagsResponse.errorsWhileComputingFlags) {\n      console.error(\n        '[FEATURE FLAGS] Error while computing feature flags, some flags may be missing or incorrect. Learn more at https://posthog.com/docs/feature-flags/best-practices'\n      )\n    }\n\n    // Add check for quota limitation on feature flags\n    if (flagsResponse.quotaLimited?.includes(QuotaLimitedFeature.FeatureFlags)) {\n      console.warn(\n        '[FEATURE FLAGS] Feature flags quota limit exceeded - feature flags unavailable. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts'\n      )\n      return {\n        flags: {},\n        featureFlags: {},\n        featureFlagPayloads: {},\n        requestId: flagsResponse?.requestId,\n      }\n    }\n\n    return flagsResponse\n  }\n\n  /***\n   *** SURVEYS\n   ***/\n\n  public async getSurveysStateless(): Promise<SurveyResponse['surveys']> {\n    await this._initPromise\n\n    if (this.disableSurveys === true) {\n      this._logger.info('Loading surveys is disabled.')\n      return []\n    }\n\n    const url = `${this.host}/api/surveys/?token=${this.apiKey}`\n    const fetchOptions: PostHogFetchOptions = {\n      method: 'GET',\n      headers: { ...this.getCustomHeaders(), 'Content-Type': 'application/json' },\n    }\n\n    const response = await this.fetchWithRetry(url, fetchOptions)\n      .then((response) => {\n        if (response.status !== 200 || !response.json) {\n          const msg = `Surveys API could not be loaded: ${response.status}`\n          const error = new Error(msg)\n          this._logger.error(error)\n\n          this._events.emit('error', new Error(msg))\n          return undefined\n        }\n\n        return response.json() as Promise<SurveyResponse>\n      })\n      .catch((error) => {\n        this._logger.error('Surveys API could not be loaded', error)\n\n        this._events.emit('error', error)\n        return undefined\n      })\n\n    const newSurveys = response?.surveys\n\n    if (newSurveys) {\n      this._logger.info('Surveys fetched from API: ', JSON.stringify(newSurveys))\n    }\n\n    return newSurveys ?? []\n  }\n\n  /***\n   *** SUPER PROPERTIES\n   ***/\n  private _props: PostHogEventProperties | undefined\n\n  protected get props(): PostHogEventProperties {\n    if (!this._props) {\n      this._props = this.getPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.Props)\n    }\n    return this._props || {}\n  }\n\n  protected set props(val: PostHogEventProperties | undefined) {\n    this._props = val\n  }\n\n  async register(properties: PostHogEventProperties): Promise<void> {\n    this.wrap(() => {\n      this.props = {\n        ...this.props,\n        ...properties,\n      }\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.Props, this.props)\n    })\n  }\n\n  async unregister(property: string): Promise<void> {\n    this.wrap(() => {\n      delete this.props[property]\n      this.setPersistedProperty<PostHogEventProperties>(PostHogPersistedProperty.Props, this.props)\n    })\n  }\n\n  /***\n   *** QUEUEING AND FLUSHING\n   ***/\n  protected enqueue(type: string, _message: any, options?: PostHogCaptureOptions): void {\n    this.wrap(() => {\n      if (this.optedOut) {\n        this._events.emit(type, `Library is disabled. Not sending event. To re-enable, call posthog.optIn()`)\n        return\n      }\n\n      const message = this.prepareMessage(type, _message, options)\n\n      const queue = this.getPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue) || []\n\n      if (queue.length >= this.maxQueueSize) {\n        queue.shift()\n        this._logger.info('Queue is full, the oldest event is dropped.')\n      }\n\n      queue.push({ message })\n      this.setPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue, queue)\n\n      this._events.emit(type, message)\n\n      // Flush queued events if we meet the flushAt length\n      if (queue.length >= this.flushAt) {\n        this.flushBackground()\n      }\n\n      if (this.flushInterval && !this._flushTimer) {\n        this._flushTimer = safeSetTimeout(() => this.flushBackground(), this.flushInterval)\n      }\n    })\n  }\n\n  protected async sendImmediate(type: string, _message: any, options?: PostHogCaptureOptions): Promise<void> {\n    if (this.disabled) {\n      this._logger.warn('The client is disabled')\n      return\n    }\n\n    if (!this._isInitialized) {\n      await this._initPromise\n    }\n\n    if (this.optedOut) {\n      this._events.emit(type, `Library is disabled. Not sending event. To re-enable, call posthog.optIn()`)\n      return\n    }\n\n    const data: Record<string, any> = {\n      api_key: this.apiKey,\n      batch: [this.prepareMessage(type, _message, options)],\n      sent_at: currentISOTime(),\n    }\n\n    if (this.historicalMigration) {\n      data.historical_migration = true\n    }\n\n    const payload = JSON.stringify(data)\n\n    const url = `${this.host}/batch/`\n\n    const gzippedPayload = !this.disableCompression ? await gzipCompress(payload, this.isDebug) : null\n    const fetchOptions: PostHogFetchOptions = {\n      method: 'POST',\n      headers: {\n        ...this.getCustomHeaders(),\n        'Content-Type': 'application/json',\n        ...(gzippedPayload !== null && { 'Content-Encoding': 'gzip' }),\n      },\n      body: gzippedPayload || payload,\n    }\n\n    try {\n      await this.fetchWithRetry(url, fetchOptions)\n    } catch (err) {\n      this._events.emit('error', err)\n    }\n  }\n\n  private prepareMessage(type: string, _message: any, options?: PostHogCaptureOptions): PostHogEventProperties {\n    const message = {\n      ..._message,\n      type: type,\n      library: this.getLibraryId(),\n      library_version: this.getLibraryVersion(),\n      timestamp: options?.timestamp ? options?.timestamp : currentISOTime(),\n      uuid: options?.uuid ? options.uuid : uuidv7(),\n    }\n\n    const addGeoipDisableProperty = options?.disableGeoip ?? this.disableGeoip\n    if (addGeoipDisableProperty) {\n      if (!message.properties) {\n        message.properties = {}\n      }\n      message['properties']['$geoip_disable'] = true\n    }\n\n    if (message.distinctId) {\n      message.distinct_id = message.distinctId\n      delete message.distinctId\n    }\n\n    return message\n  }\n\n  private clearFlushTimer(): void {\n    if (this._flushTimer) {\n      clearTimeout(this._flushTimer)\n      this._flushTimer = undefined\n    }\n  }\n\n  /**\n   * Helper for flushing the queue in the background\n   * Avoids unnecessary promise errors\n   */\n  private flushBackground(): void {\n    void this.flush().catch(async (err) => {\n      await logFlushError(err)\n    })\n  }\n\n  /**\n   * Flushes the queue of pending events.\n   *\n   * This function will return a promise that will resolve when the flush is complete,\n   * or reject if there was an error (for example if the server or network is down).\n   *\n   * If there is already a flush in progress, this function will wait for that flush to complete.\n   *\n   * It's recommended to do error handling in the callback of the promise.\n   *\n   * {@label Initialization}\n   *\n   * @example\n   * ```js\n   * // flush with error handling\n   * posthog.flush().then(() => {\n   *   console.log('Flush complete')\n   * }).catch((err) => {\n   *   console.error('Flush failed', err)\n   * })\n   * ```\n   *\n   * @public\n   *\n   * @throws PostHogFetchHttpError\n   * @throws PostHogFetchNetworkError\n   * @throws Error\n   */\n  async flush(): Promise<void> {\n    // Wait for the current flush operation to finish (regardless of success or failure), then try to flush again.\n    // Use allSettled instead of finally to be defensive around flush throwing errors immediately rather than rejecting.\n    // Use a custom allSettled implementation to avoid issues with patching Promise on RN\n    const nextFlushPromise = allSettled([this.flushPromise]).then(() => {\n      return this._flush()\n    })\n\n    this.flushPromise = nextFlushPromise\n    void this.addPendingPromise(nextFlushPromise)\n\n    allSettled([nextFlushPromise]).then(() => {\n      // If there are no others waiting to flush, clear the promise.\n      // We don't strictly need to do this, but it could make debugging easier\n      if (this.flushPromise === nextFlushPromise) {\n        this.flushPromise = null\n      }\n    })\n\n    return nextFlushPromise\n  }\n\n  protected getCustomHeaders(): { [key: string]: string } {\n    // Don't set the user agent if we're not on a browser. The latest spec allows\n    // the User-Agent header (see https://fetch.spec.whatwg.org/#terminology-headers\n    // and https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader),\n    // but browsers such as Chrome and Safari have not caught up.\n    const customUserAgent = this.getCustomUserAgent()\n    const headers: { [key: string]: string } = {}\n    if (customUserAgent && customUserAgent !== '') {\n      headers['User-Agent'] = customUserAgent\n    }\n    return headers\n  }\n\n  private async _flush(): Promise<void> {\n    this.clearFlushTimer()\n    await this._initPromise\n\n    let queue = this.getPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue) || []\n\n    if (!queue.length) {\n      return\n    }\n\n    const sentMessages: any[] = []\n    const originalQueueLength = queue.length\n\n    while (queue.length > 0 && sentMessages.length < originalQueueLength) {\n      const batchItems = queue.slice(0, this.maxBatchSize)\n      const batchMessages = batchItems.map((item) => item.message)\n\n      const persistQueueChange = (): void => {\n        const refreshedQueue = this.getPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue) || []\n        const newQueue = refreshedQueue.slice(batchItems.length)\n        this.setPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue, newQueue)\n        queue = newQueue\n      }\n\n      const data: Record<string, any> = {\n        api_key: this.apiKey,\n        batch: batchMessages,\n        sent_at: currentISOTime(),\n      }\n\n      if (this.historicalMigration) {\n        data.historical_migration = true\n      }\n\n      const payload = JSON.stringify(data)\n\n      const url = `${this.host}/batch/`\n\n      const gzippedPayload = !this.disableCompression ? await gzipCompress(payload, this.isDebug) : null\n      const fetchOptions: PostHogFetchOptions = {\n        method: 'POST',\n        headers: {\n          ...this.getCustomHeaders(),\n          'Content-Type': 'application/json',\n          ...(gzippedPayload !== null && { 'Content-Encoding': 'gzip' }),\n        },\n        body: gzippedPayload || payload,\n      }\n\n      const retryOptions: Partial<RetriableOptions> = {\n        retryCheck: (err) => {\n          // don't automatically retry on 413 errors, we want to reduce the batch size first\n          if (isPostHogFetchContentTooLargeError(err)) {\n            return false\n          }\n          // otherwise, retry on network errors\n          return isPostHogFetchError(err)\n        },\n      }\n\n      try {\n        await this.fetchWithRetry(url, fetchOptions, retryOptions)\n      } catch (err) {\n        if (isPostHogFetchContentTooLargeError(err) && batchMessages.length > 1) {\n          // if we get a 413 error, we want to reduce the batch size and try again\n          this.maxBatchSize = Math.max(1, Math.floor(batchMessages.length / 2))\n          this._logger.warn(\n            `Received 413 when sending batch of size ${batchMessages.length}, reducing batch size to ${this.maxBatchSize}`\n          )\n          // do not persist the queue change, we want to retry the same batch\n          continue\n        }\n\n        // depending on the error type, eg a malformed JSON or broken queue, it'll always return an error\n        // and this will be an endless loop, in this case, if the error isn't a network issue, we always remove the items from the queue\n        if (!(err instanceof PostHogFetchNetworkError)) {\n          persistQueueChange()\n        }\n        this._events.emit('error', err)\n\n        throw err\n      }\n\n      persistQueueChange()\n\n      sentMessages.push(...batchMessages)\n    }\n    this._events.emit('flush', sentMessages)\n  }\n\n  private async fetchWithRetry(\n    url: string,\n    options: PostHogFetchOptions,\n    retryOptions?: Partial<RetriableOptions>,\n    requestTimeout?: number\n  ): Promise<PostHogFetchResponse> {\n    ;(AbortSignal as any).timeout ??= function timeout(ms: number) {\n      const ctrl = new AbortController()\n      setTimeout(() => ctrl.abort(), ms)\n      return ctrl.signal\n    }\n\n    const body = options.body ? options.body : ''\n    let reqByteLength = -1\n    try {\n      if (body instanceof Blob) {\n        reqByteLength = body.size\n      } else {\n        reqByteLength = Buffer.byteLength(body, STRING_FORMAT)\n      }\n    } catch {\n      if (body instanceof Blob) {\n        reqByteLength = body.size\n      } else {\n        const encoded = new TextEncoder().encode(body)\n        reqByteLength = encoded.length\n      }\n    }\n\n    return await retriable(\n      async () => {\n        let res: PostHogFetchResponse | null = null\n        try {\n          res = await this.fetch(url, {\n            signal: (AbortSignal as any).timeout(requestTimeout ?? this.requestTimeout),\n            ...options,\n          })\n        } catch (e) {\n          // fetch will only throw on network errors or on timeouts\n          throw new PostHogFetchNetworkError(e)\n        }\n        // If we're in no-cors mode, we can't access the response status\n        // We only throw on HTTP errors if we're not in no-cors mode\n        // https://developer.mozilla.org/en-US/docs/Web/API/Request/mode#no-cors\n        const isNoCors = options.mode === 'no-cors'\n        if (!isNoCors && (res.status < 200 || res.status >= 400)) {\n          throw new PostHogFetchHttpError(res, reqByteLength)\n        }\n        return res\n      },\n      { ...this._retryOptions, ...retryOptions }\n    )\n  }\n\n  async _shutdown(shutdownTimeoutMs: number = 30000): Promise<void> {\n    // A little tricky - we want to have a max shutdown time and enforce it, even if that means we have some\n    // dangling promises. We'll keep track of the timeout and resolve/reject based on that.\n\n    await this._initPromise\n    let hasTimedOut = false\n    this.clearFlushTimer()\n\n    const doShutdown = async (): Promise<void> => {\n      try {\n        await this.promiseQueue.join()\n\n        while (true) {\n          const queue = this.getPersistedProperty<PostHogQueueItem[]>(PostHogPersistedProperty.Queue) || []\n\n          if (queue.length === 0) {\n            break\n          }\n\n          // flush again to make sure we send all events, some of which might've been added\n          // while we were waiting for the pending promises to resolve\n          // For example, see sendFeatureFlags in posthog-node/src/posthog-node.ts::capture\n          await this.flush()\n\n          if (hasTimedOut) {\n            break\n          }\n        }\n      } catch (e) {\n        if (!isPostHogFetchError(e)) {\n          throw e\n        }\n\n        await logFlushError(e)\n      }\n    }\n\n    return Promise.race([\n      new Promise<void>((_, reject) => {\n        safeSetTimeout(() => {\n          this._logger.error('Timed out while shutting down PostHog')\n          hasTimedOut = true\n          reject('Timeout while shutting down PostHog. Some events may not have been sent.')\n        }, shutdownTimeoutMs)\n      }),\n      doShutdown(),\n    ])\n  }\n\n  /**\n   * Shuts down the PostHog instance and ensures all events are sent.\n   *\n   * Call shutdown() once before the process exits to ensure that all events have been sent and all promises\n   * have resolved. Do not use this function if you intend to keep using this PostHog instance after calling it.\n   * Use flush() for per-request cleanup instead.\n   *\n   * {@label Initialization}\n   *\n   * @example\n   * ```js\n   * // shutdown before process exit\n   * process.on('SIGINT', async () => {\n   *   await posthog.shutdown()\n   *   process.exit(0)\n   * })\n   * ```\n   *\n   * @public\n   *\n   * @param {number} [shutdownTimeoutMs=30000] Maximum time to wait for shutdown in milliseconds\n   * @returns {Promise<void>} A promise that resolves when shutdown is complete\n   */\n  async shutdown(shutdownTimeoutMs: number = 30000): Promise<void> {\n    if (this.shutdownPromise) {\n      this._logger.warn(\n        'shutdown() called while already shutting down. shutdown() is meant to be called once before process exit - use flush() for per-request cleanup'\n      )\n    } else {\n      this.shutdownPromise = this._shutdown(shutdownTimeoutMs).finally(() => {\n        this.shutdownPromise = null\n      })\n    }\n    return this.shutdownPromise\n  }\n}\n"]}